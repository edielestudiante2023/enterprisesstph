<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <br>
  <title>Hoja de Vida Brigadista</title>
  <style>
    /* Mobile-first approach */
    body{font-family:system-ui,Arial,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .wrap{
      max-width:860px;
      margin:8px;
      padding:12px;
      background:#fff;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.08)
    }
    h1{margin:0 0 16px;font-size:1.4rem}
    h3{font-size:1.1rem;margin:0 0 12px}
    
    /* Grid - mobile first (single column) */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px
    }
    
    label{font-weight:600;font-size:.9rem;margin-top:8px;display:block}
    input,select,textarea{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
      font-size:16px;
      box-sizing:border-box
    }
    
    /* Select2 mobile styles */
    .select2-container{width:100%!important}
    .select2-selection{
      min-height:48px!important;
      border:1px solid #ddd!important;
      border-radius:8px!important;
      font-size:16px!important
    }
    .select2-selection__rendered{padding:12px!important;line-height:22px!important}
    .select2-selection__arrow{height:46px!important}
    .select2-dropdown{font-size:16px!important}
    .select2-results__option{padding:12px!important}
    
    textarea{min-height:80px;resize:vertical}
    
    /* Responsive buttons */
    .row{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px
    }
    button{
      padding:14px 16px;
      border:0;
      border-radius:8px;
      background:#1a73e8;
      color:#fff;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      width:100%
    }
    button.secondary{background:#5f6368}
    button:active{transform:scale(0.98)}
    
    /* Media elements */
    video,canvas{width:100%;border-radius:8px;background:#000;max-height:400px}
    
    .section{margin-top:24px;padding-top:16px;border-top:1px dashed #e6e6e6}
    .sig{
      border:1px dashed #bbb;
      background:#fafafa;
      height:200px;
      touch-action:none;
      display:block;
      width:100%;
      box-sizing:border-box
    }
    .full{grid-column:1 / -1}
    .note{font-size:.85rem;color:#5f6368;line-height:1.4}
    #status{margin-top:12px;font-weight:700;padding:8px;border-radius:6px}
    
    /* Studies container mobile optimization */
    #estudios-container{
      border:1px solid #ddd;
      border-radius:8px;
      padding:12px;
      background:#fafafa;
      margin-top:12px
    }
    .estudio-record{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
      padding:12px;
      background:white;
      border-radius:6px;
      border:1px solid #e6e6e6
    }
    .estudio-record button{margin-top:8px}
    
    /* File input styling - DUPLICADO */
    input[type="file"]{
      padding:16px; /* DOBLE: de 8px a 16px */
      font-size:28px; /* DOBLE: de 14px a 28px */
      border:4px dashed #ddd; /* DOBLE: de 2px a 4px */
      background:#fafafa;
      border-radius: 16px; /* Agregado para consistencia */
      min-height: 120px; /* Agregado para mejor touch */
    }
    
    /* Desktop styles - mantener tama√±os grandes */
    @media (min-width: 768px) {
      .wrap{margin:24px auto;padding:20px}
      h1{font-size:1.8rem}
      .row{flex-direction:row;flex-wrap:wrap}
      button{width:auto;min-width:120px}
      .sig{height:180px}
      .estudio-record{
        grid-template-columns:1fr auto;
        align-items:end
      }
      .estudio-record button{margin-top:0}
      /* Mantener fuentes grandes incluso en desktop */
    }
    
    /* Large desktop */
    @media (min-width: 1024px) {
      .wrap{margin:24px auto}
      h1{font-size:2rem}
    }

    /* ===== JOTFORM‚ÄëLIKE MOBILE THEME (overrides) ===== */
    :root{
      --radius:16px;
      --pad:14px;
      --fieldH:60px;
      --font: clamp(18px, 3.2vw, 20px);
      --font-sm: clamp(16px, 2.8vw, 18px);
      --brand:#ff6100;
      --brand-light:#ff7900;
      --brand-gradient:linear-gradient(135deg, #ff6100, #ff8c42);
      --brand-gradient-hover:linear-gradient(135deg, #e55a00, #ff7900);
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:linear-gradient(135deg, #f8f9fc 0%, #f1f3f8 100%);
    }

    html,body{background:var(--bg);}
    body{font-size:var(--font); color:var(--ink);}

    .wrap{
      max-width:min(760px, 94vw);
      margin:16px auto;
      padding:18px;
      border-radius:calc(var(--radius) + 4px);
    }

    h1{font-size:clamp(20px,3.8vw,28px); font-weight:800; margin-bottom:8px;}
    h3{font-size:clamp(18px,3.2vw,22px); font-weight:700; margin:6px 0 10px;}

    /* Secciones como tarjetas */
    .section{
      border:none;
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      margin-top:24px;
      box-shadow:0 8px 25px rgba(0,0,0,.08), 0 3px 6px rgba(0,0,0,.04);
      position:relative;
    }
    
    /* Header con gradiente */
    .section:first-of-type{
      background:var(--brand-gradient);
      color:#fff;
      box-shadow:0 10px 30px rgba(255, 97, 0, .20);
      min-height:80px;
    }
    .section:first-of-type .note{
      color:rgba(255,255,255,.8);
    }
    
    /* Logos del header */
    .section:first-of-type img{
      background:rgba(255,255,255,.95);
      padding:4px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      transition:transform .2s ease;
    }
    .section:first-of-type img:hover{
      transform:scale(1.05);
    }
    
    /* Responsive logos */
    @media (max-width: 480px){
      .section:first-of-type{
        flex-direction:column;
        text-align:center;
        gap:8px;
      }
      .section:first-of-type img{
        width:40px;
        height:40px;
      }
    }

    /* Grid - SIEMPRE una sola columna para mejor UX m√≥vil */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
    }
    /* Mantener una columna incluso en desktop para formularios */
    .full{grid-column:1/-1}

    /* Secciones numeradas */
    .section h3::before{
      content:counter(section-counter) ". ";
      counter-increment:section-counter;
      color:var(--brand);
      font-weight:900;
    }
    .wrap{
      counter-reset:section-counter;
    }
    .section:first-of-type h3::before{
      display:none; /* No numerar el header */
    }
    
    /* Etiquetas y campos grandes (evita zoom iOS) */
    label{
      display:block; 
      font-weight:700; 
      font-size:var(--font-sm); 
      margin:8px 0 8px;
      line-height:1.3;
    }
    
    /* Label especial para cliente - texto m√°s grande */
    label[for="clienteSelect"]{
      font-size:calc(var(--font-sm) * 2);
      font-weight:800;
    }
    
    /* Labels con iconos */
    label[for="clienteSelect"]::before{content:"üè¢ ";}
    label[for="nombre_completo"]::before{content:"üë§ ";}
    label[for="documento_identidad"]::before{content:"üÜî ";}
    label[for="email"]::before{content:"üìß ";}
    label[for="telefono"]::before{content:"üì± ";}
    label[for="direccion_residencia"]::before{content:"üè† ";}
    label[for="f_nacimiento"]::before{content:"üìÖ ";}
    label[for="eps"]::before{content:"üè• ";}
    label[for="peso"]::before{content:"‚öñÔ∏è ";}
    label[for="estatura"]::before{content:"üìè ";}
    
    /* Campos requeridos */
    label[for="clienteSelect"]::after,
    label[for="nombre_completo"]::after,
    label[for="documento_identidad"]::after,
    label[for="f_nacimiento"]::after,
    label[for="email"]::after,
    label[for="telefono"]::after,
    label[for="direccion_residencia"]::after,
    label[for="eps"]::after,
    label[for="rh"]::after,
    label[for="peso"]::after,
    label[for="estatura"]::after,
    label[for="edad"]::after,
    label[for="enfermedades_importantes"]::after,
    label[for="medicamentos"]::after,
    label[for="restricciones_medicas"]::after,
    label[for="deporte_semana"]::after{
      content:" *";
      color:#e53e3e;
      font-weight:900;
    }
    
    /* Asteriscos ya incluidos en el texto del label */
    label:has(+ select[required])::after,
    label:has(+ input[required])::after,
    label:has(+ textarea[required])::after{
      content:"";
    }

    input,select,textarea{
      width:100%;
      min-height:calc(var(--fieldH) * 3); /* TRIPLICADO */
      padding:48px 54px; /* TRIPLICADO: de 16x18 a 48x54 */
      border:2px solid #d9dce3;
      border-radius:12px;
      background:#fff;
      font-size:54px; /* TRIPLICADO: de 18px a 54px */
      outline:none;
      transition:border .15s, box-shadow .15s, background .15s;
      box-sizing:border-box;
    }
    
    /* Placeholders m√°s grandes - DOBLE TAMA√ëO */
    input::placeholder,
    textarea::placeholder{
      font-size:108px!important; /* DOBLE del tama√±o actual: 54px x 2 = 108px */
      color:#9ca3af;
      opacity:0.7;
    }
    
    /* Placeholders espec√≠ficos m√°s peque√±os - MITAD DEL TAMA√ëO ACTUAL */
    #enfermedades_importantes::placeholder,
    #medicamentos::placeholder,
    #restricciones_medicas::placeholder,
    #deporte_semana::placeholder,
    #f_nacimiento::placeholder,
    #documento_identidad::placeholder,
    #telefono::placeholder,
    #email::placeholder,
    .estudio-nombre::placeholder,
    .estudio-institucion::placeholder,
    .estudio-anio::placeholder{
      font-size:54px!important; /* MITAD: de 108px a 54px */
      color:#9ca3af;
      opacity:0.7;
    }
    textarea{min-height:330px;} /* TRIPLICADO: de 110px a 330px */
    input:focus,select:focus,textarea:focus{
      border-color: var(--brand);
      box-shadow:0 0 0 4px rgba(26,115,232,.12);
    }

    /* Select2 escalado */
    .select2-container{width:100%!important; font-size:36px;}
    .select2-selection{
      min-height:calc(var(--fieldH) * 2)!important;
      border:2px solid #d9dce3!important;
      border-radius:12px!important;
    }
    .select2-selection__rendered{padding:32px 36px!important; line-height:52px!important;}
    .select2-selection__arrow{height:calc(var(--fieldH) * 2)!important;}
    .select2-results__option{padding:32px 36px!important; font-size:36px!important;}
    
    /* FIJAR Z-INDEX para que Select2 aparezca siempre encima */
    .select2-dropdown{
      z-index:99999!important; /* Aumentado a√∫n m√°s */
      border:2px solid #d9dce3!important;
      border-radius:12px!important;
      box-shadow:0 8px 25px rgba(0,0,0,.15)!important;
      max-height:400px!important; /* Asegurar altura m√°xima */
      overflow-y:auto!important; /* Scroll si hay muchas opciones */
    }
    .select2-container--open{
      z-index:99999!important; /* Aumentado a√∫n m√°s */
    }
    .select2-container--open .select2-dropdown--above{
      z-index:99999!important;
    }
    .select2-container--open .select2-dropdown--below{
      z-index:99999!important;
    }

    /* Botones grandes + primario vistoso */
    .row{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    button{
      min-height:var(--fieldH);
      padding:10px 16px;
      border:0; border-radius:12px;
      background:var(--brand-gradient);
      color:#fff;
      font-weight:800; letter-spacing:.2px;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 4px 12px rgba(255, 97, 0, .25);
    }
    button:hover{
      background:var(--brand-gradient-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(255, 97, 0, .35);
    }
    button.secondary{
      background:linear-gradient(135deg, #64748b, #7c8a99);
      box-shadow:0 4px 12px rgba(100, 116, 139, .25);
    }
    button:active{transform:scale(.98) translateY(0)}

    /* Bot√≥n Enviar normal (no sticky) */
    .actions{
      background:#fff; border:1px solid #e5e7eb;
      border-radius:16px; padding:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.10);
      display:flex; gap:10px; flex-direction:column;
      margin-top:12px;
    }

    /* NUEVA secci√≥n de estudios - dise√±o vertical armonizado */
    #estudios-container{
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    
    .estudio-record{
      background: var(--card);
      border: 2px solid #e5e7eb;
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      position: relative;
    }
    
    .estudio-record label{
      font-size: calc(var(--font-sm) * 1.5); /* M√°s grande que labels normales */
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 12px;
      display: block;
    }
    
    .estudio-record input{
      width: 100%;
      min-height: calc(var(--fieldH) * 3); /* Mismo tama√±o que otros inputs */
      padding: 48px 54px; /* Mismo padding que otros inputs */
      border: 2px solid #d9dce3;
      border-radius: 12px;
      background: #fff;
      font-size: 54px; /* Mismo tama√±o de fuente que otros inputs */
      outline: none;
      transition: border .15s, box-shadow .15s;
      box-sizing: border-box;
    }
    
    .estudio-record input:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
    }
    
    .estudio-record input::placeholder{
      font-size: 54px!important; /* MITAD: de 108px a 54px */
      color: #9ca3af;
      opacity: 0.7;
    }
    
    .btn-remove-estudio{
      position: absolute;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ea4335;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(234, 67, 53, 0.3);
      transition: all 0.2s ease;
    }
    
    .btn-remove-estudio:hover{
      background: #d33b2c;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(234, 67, 53, 0.4);
    }
    
    #btn-add-estudio{
      width: 100%;
      min-height: calc(var(--fieldH) * 1.5);
      padding: 24px 32px;
      border: 3px dashed #34a853;
      background: transparent;
      color: #34a853;
      border-radius: 16px;
      cursor: pointer;
      font-size: 28px; /* M√°s grande para destacar */
      font-weight: 700;
      touch-action: manipulation;
      margin-top: 24px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    #btn-add-estudio:hover{
      background: #f0f9f4;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 168, 83, 0.2);
    }

    /* Media: c√°mara y firma m√°s amigables */
    video,canvas#photoCanvas{
      width:100%; max-height:320px; border-radius:12px; background:#000;
      aspect-ratio:4/3; object-fit:cover;
    }
    .sig{height:220px; border-radius:12px;}
    
    /* Botones de foto m√°s grandes y touch-friendly - DUPLICADOS */
    #btnClearPhoto, #btnClearSig{
      min-height: 108px; /* DOBLE: de 54px a 108px */
      padding: 32px 48px; /* DOBLE: de 16x24 a 32x48 */
      font-size: 32px; /* DOBLE: de 16px a 32px */
      font-weight: 600;
      border-radius: 24px; /* DOBLE: de 12px a 24px */
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    /* Botones principales de c√°mara - DOBLE TAMA√ëO */
    #btnStartCam, #btnShot{
      min-height: 108px;
      padding: 32px 48px;
      font-size: 32px;
      font-weight: 700;
      border-radius: 16px;
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    #btnStartCam{
      background: #9c27b0;
      color: white;
      border: none;
    }
    #btnStartCam:hover{
      background: #7b1fa2;
      transform: translateY(-2px);
    }
    #btnShot{
      background: #1a73e8;
      color: white;
      border: none;
    }
    #btnShot:hover{
      background: #1557b0;
      transform: translateY(-2px);
    }
    #btnClearPhoto, #btnClearSig{
      background: #f1f3f4;
      color: #5f6368;
      border: 2px solid #dadce0;
    }
    #btnClearPhoto:hover, #btnClearSig:hover{
      background: #e8eaed;
      transform: translateY(-2px);
    }
    
    /* Bot√≥n de env√≠o m√°s grande pero fijo al final */
    #btnSubmit{
      min-height: 120px;
      padding: 36px 64px;
      font-size: 36px;
      font-weight: 700;
      border-radius: 28px;
      background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
      color: white;
      border: none;
      box-shadow: 0 8px 24px rgba(255, 123, 0, 0.3);
      touch-action: manipulation;
      transition: all 0.3s ease;
      width: 100%;
    }
    #btnSubmit:hover{
      background: linear-gradient(135deg, #e56b00 0%, #e58500 100%);
      transform: translateY(-6px);
      box-shadow: 0 12px 40px rgba(255, 123, 0, 0.4);
    }
    #btnSubmit:active{
      transform: translateY(-2px);
    }

    /* Estado/nota */
    .note{color:var(--muted); font-size:var(--font-sm);}
    #status{
      font-size:32px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:700;
      text-align:center;
      padding:24px;
      border-radius:16px;
      margin-top:24px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="section full" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <img src="https://lh3.googleusercontent.com/d/1VdWAxjvIhrvRulvjRRcRh38t4BEzxNJh" alt="Logo Empresa" style="width:48px;height:48px;border-radius:8px;object-fit:contain;" onerror="this.src='https://drive.google.com/thumbnail?id=1VdWAxjvIhrvRulvjRRcRh38t4BEzxNJh&sz=w200'">
      <div style="text-align:center;flex:1;">
        <div style="font-weight:800;line-height:1;font-size:calc(var(--font) * 4);">Formulario de Brigadistas</div>
        <div class="note" style="font-size:calc(var(--font-sm) * 4);">Completa los campos y adjunta foto y firma</div>
      </div>
      <img src="https://lh3.googleusercontent.com/d/1EX4yhuMo0r7dlklF4n5TbaCKRZ2skTx7" alt="Logo Secundario" style="width:48px;height:48px;border-radius:8px;object-fit:contain;" onerror="this.src='https://drive.google.com/thumbnail?id=1EX4yhuMo0r7dlklF4n5TbaCKRZ2skTx7&sz=w200'">
    </div>
    
    <h1 style="margin-top:48px;">Hoja de Vida ‚Äì Brigadista</h1>

    <!-- CLIENTE -->
    <div class="section">
      <h3>Selecci√≥n de Cliente</h3>
      <div class="grid">
        <div class="full">
          <label for="clienteSelect">üè¢ Cliente *</label>
          <select id="clienteSelect" required></select>
          <input type="hidden" id="idCliente" />
        </div>
      </div>
    </div>

    <!-- DATOS PERSONALES -->
    <div class="section">
      <h3>Datos Personales</h3>
      <div class="grid">
      <div>
        <label for="nombre_completo">Nombre completo *</label>
        <input id="nombre_completo" required />
      </div>
      <div>
        <label for="documento_identidad">Documento de identidad *</label>
        <input id="documento_identidad" type="text" pattern="[0-9]+" inputmode="numeric" maxlength="12" required placeholder="Ej: 1234567890" />
      </div>
      <div>
        <label for="f_nacimiento">Fecha de nacimiento *</label>
        <div style="position: relative;">
          <input id="f_nacimiento" type="text" pattern="\d{2}/\d{2}/\d{4}" placeholder="dd/mm/yyyy" maxlength="10" required style="padding-right: 50px;" />
          <input id="f_nacimiento_date" type="date" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; pointer-events: none;" />
          <button type="button" id="date-mode-toggle" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--brand-gradient); color: white; border: 0; border-radius: 6px; padding: 8px 10px; font-size: 16px; cursor: pointer; z-index: 10;">üìÖ</button>
        </div>
        <input type="hidden" id="f_nacimiento_iso" />
        <div id="date-mode-hint" style="font-size: 14px; color: #6b7280; margin-top: 4px;">‚úçÔ∏è Modo texto: Escribe dd/mm/yyyy</div>
      </div>
      <div>
        <label for="email">Email *</label>
        <input id="email" type="email" required placeholder="Ej: nombre@empresa.com" />
      </div>
      <div>
        <label for="telefono">Tel√©fono *</label>
        <input id="telefono" type="text" pattern="[0-9]{10}" inputmode="tel" maxlength="10" required placeholder="Ej: 3001234567" />
      </div>
      <div>
        <label for="direccion_residencia">Direcci√≥n *</label>
        <input id="direccion_residencia" required />
      </div>
      <div>
        <label for="eps">EPS *</label>
        <input id="eps" required />
      </div>
      <div>
        <label for="rh">ü©∏ RH *</label>
        <select id="rh" required>
          <option value="">-- Seleccionar tipo de sangre --</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
        </select>
      </div>
      <div>
        <label for="peso">Peso (kg) *</label>
        <input id="peso" type="number" step="0.1" required />
      </div>
      <div>
        <label for="estatura">Estatura (cm) *</label>
        <input id="estatura" type="number" step="0.1" required />
      </div>
      <div>
        <label for="edad">Edad *</label>
        <input id="edad" type="number" required />
      </div>
    </div>

    <!-- ESTUDIOS -->
    <div class="section">
      <div class="full"><h3>Estudios Relacionados con la Respuesta ante Emergencias</h3></div>
      <div id="estudios-container">
        <div class="estudio-record">
          <button type="button" class="btn-remove-estudio">√ó</button>
          
          <div>
            <label>üìö ¬øQu√© estudi√≥?</label>
            <input class="estudio-nombre" placeholder="Ej: Primeros Auxilios, Rescate en Alturas, Bombero..." />
          </div>
          
          <div>
            <label>üè¢ ¬øD√≥nde lo estudi√≥?</label>
            <input class="estudio-institucion" placeholder="Ej: Cruz Roja, Defensa Civil, SENA, Universidad..." />
          </div>
          
          <div>
            <label>üìÖ ¬øEn qu√© a√±o?</label>
            <input class="estudio-anio" type="number" placeholder="Ej: 2020" min="1950" max="2030" />
          </div>
        </div>
        <button type="button" id="btn-add-estudio">‚ûï Agregar otro estudio</button>
      </div>
    </div>

    <!-- SALUD -->
    <div class="section">
      <h3>Informaci√≥n de Salud</h3>
      <div class="grid">
      <div class="full">
        <label for="enfermedades_importantes">üè• Enfermedades importantes *</label>
        <textarea id="enfermedades_importantes" required placeholder="Indica si tienes alguna enfermedad importante o escribe 'Ninguna'"></textarea>
      </div>
      <div class="full">
        <label for="medicamentos">üíä Medicamentos *</label>
        <textarea id="medicamentos" required placeholder="Indica si tomas medicamentos o escribe 'Ninguno'"></textarea>
      </div>
      </div>
    </div>

    <!-- CUESTIONARIO M√âDICO -->
    <div class="section">
      <h3>Cuestionario M√©dico (S√≠/No)</h3>
      <div class="grid" style="margin-top: 12px;">
        <div>
          <label>1. ¬øAlguna vez su doctor le ha dicho que tenga alguna enfermedad cardiaca y le ha recomendado que s√≥lo practique ejercicio m√©dicamente prescrito?</label>
          <select id="cardiaca" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>2. ¬øSiente dolor en el pecho cuando hace alguna actividad f√≠sica?</label>
          <select id="pechoactividad" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>3. ¬øEn el mes pasado ha tenido dolor en el pecho en reposo?</label>
          <select id="dolorpecho" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>4. ¬øPierde usted el equilibrio por mareo o ha perdido la conciencia alguna vez?</label>
          <select id="conciencia" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>5. ¬øTiene usted alg√∫n problema de los huesos o articulaciones que pudieran empeorar por un cambio en la actividad f√≠sica?</label>
          <select id="huesos" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>6. ¬øEst√° su m√©dico prescribiendo actualmente medicamentos para la presi√≥n arterial, diabetes o alguna condici√≥n cardiaca?</label>
          <select id="medicamentos_bool" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>7. ¬øConoce alguna otra raz√≥n por la cual usted no pueda realizar actividad f√≠sica?</label>
          <select id="actividadfisica" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>8. ¬øHa sufrido o sufre de convulsiones o epilepsia?</label>
          <select id="convulsiones" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>9. ¬øSufre o ha sufrido de v√©rtigo?</label>
          <select id="vertigo" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>10. ¬øHa sufrido de enfermedades en los o√≠dos?</label>
          <select id="oidos" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>11. ¬øHa sufrido de miedo a los lugares cerrados (ascensores, cuartos peque√±os)?</label>
          <select id="lugarescerrados" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>12. ¬øHa sufrido de miedo a las alturas (aviones, puentes peatonales, terrazas)?</label>
          <select id="miedoalturas" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>13. ¬øHace en la semana ejercicio?</label>
          <select id="haceejercicio" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>14. ¬øSufre de miedo al ver sangre?</label>
          <select id="miedo_ver_sangre" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
      </div>
      <div class="full">
        <label for="restricciones_medicas">Restricciones m√©dicas *</label>
        <textarea id="restricciones_medicas" required placeholder="Indica si tienes restricciones m√©dicas o escribe 'Ninguna'"></textarea>
      </div>
      <div class="full">
        <label for="deporte_semana">Deportes y horas/semana *</label>
        <textarea id="deporte_semana" required placeholder="Indica qu√© deportes practicas y cu√°ntas horas por semana, o escribe 'Ninguno'"></textarea>
      </div>
    </div>

    <!-- FOTO -->
    <div class="section">
      <label>üì∏ Foto del brigadista *</label>
      <div style="margin-bottom: 16px;">
        <button id="btnStartCam" type="button">üìπ Encender c√°mara</button>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="photoCanvas" style="display:none"></canvas>
      <div class="row">
        <button id="btnShot" type="button">üì∑ Tomar foto</button>
        <button id="btnClearPhoto" class="secondary" type="button">Borrar foto</button>
      </div>
      <!-- Fallback para dispositivos antiguos -->
      <div class="row" style="margin-top: 8px;">
        <label style="font-size: 1.8rem; color: #5f6368;">O seleccionar archivo:</label>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
      </div>
    </div>

    <!-- FIRMA -->
    <div class="section">
      <label>‚úçÔ∏è Firma *</label>
      <canvas id="sigCanvas" class="sig"></canvas>
      <div class="row">
        <button id="btnClearSig" class="secondary" type="button">Borrar firma</button>
      </div>
    </div>

    <!-- ENV√çO -->
    <div class="section full">
      <div class="actions">
        <button id="btnSubmit" type="button">Enviar</button>
        <div id="status"></div>
      </div>
    </div>
  </div>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <!-- Firma -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.4/dist/signature_pad.umd.min.js"></script>

  <script>
    // ===== Dropdown clientes activos =====
    function cargarClientes() {
      google.script.run.withSuccessHandler((list) => {
        const sel = $('#clienteSelect');
        sel.empty();
        sel.append('<option value="">-- Seleccione cliente --</option>');
        
        list.forEach(c => {
          sel.append(`<option value="${c.id}">${c.name}</option>`);
        });
        
        // Inicializar Select2 despu√©s de cargar los datos
        sel.select2({
          placeholder: '-- Seleccione o busque cliente --',
          allowClear: true,
          width: '100%',
          dropdownParent: $('body'), // CAMBIO: adjuntar al body para mejor z-index
          language: {
            noResults: () => 'No se encontraron resultados',
            searching: () => 'Buscando...'
          }
        });
        
        // Manejar el cambio de selecci√≥n
        sel.on('change', function() {
          document.getElementById('idCliente').value = this.value;
        });
        
      }).getActiveClients();
    }

    // El event listener ya no es necesario, se maneja en Select2

    // ===== C√°mara =====
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('photoCanvas');
    const btnStartCam = document.getElementById('btnStartCam');
    const btnShot = document.getElementById('btnShot');
    const btnClearPhoto = document.getElementById('btnClearPhoto');
    const fileInput = document.getElementById('fileInput');
    let stream = null, photoDataUrl = '';

    btnStartCam.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (e) {
        alert('No se pudo acceder a la c√°mara: ' + e);
      }
    };

    btnShot.onclick = () => {
      const w = video.videoWidth || 640, h = video.videoHeight || 480;
      photoCanvas.width = w; photoCanvas.height = h;
      const ctx = photoCanvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      photoDataUrl = photoCanvas.toDataURL('image/png');
      photoCanvas.style.display = 'block';
    };

    btnClearPhoto.onclick = () => {
      const ctx = photoCanvas.getContext('2d');
      ctx.clearRect(0,0,photoCanvas.width,photoCanvas.height);
      photoCanvas.style.display = 'none';
      photoDataUrl = '';
      fileInput.value = '';
    };

    // Fallback: selecci√≥n de archivo
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            photoCanvas.width = img.width;
            photoCanvas.height = img.height;
            const ctx = photoCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            photoDataUrl = photoCanvas.toDataURL('image/png');
            photoCanvas.style.display = 'block';
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    };

    // ===== Firma =====
    const sigCanvas = document.getElementById('sigCanvas');
    let signaturePad = null;
    
    function initSignature() {
      // Configurar el tama√±o del canvas correctamente
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const canvasRect = sigCanvas.getBoundingClientRect();
        
        sigCanvas.width = canvasRect.width * ratio;
        sigCanvas.height = canvasRect.height * ratio;
        sigCanvas.getContext("2d").scale(ratio, ratio);
        
        // Reinicializar SignaturePad despu√©s del redimensionado
        if (signaturePad) {
          signaturePad.clear();
        }
        signaturePad = new SignaturePad(sigCanvas, {
          minWidth: 0.5,
          maxWidth: 2.5,
          penColor: 'rgb(66, 133, 244)'
        });
      }
      
      resizeCanvas();
      
      // Redimensionar cuando cambie el tama√±o de la ventana
      window.addEventListener('resize', resizeCanvas);
      window.addEventListener('orientationchange', () => {
        setTimeout(resizeCanvas, 100);
      });
    }
    
    document.getElementById('btnClearSig').onclick = () => signaturePad && signaturePad.clear();

    // ===== Funciones auxiliares =====
    function calcEdad_(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return '';
      const b = new Date(yyyy_mm_dd), t = new Date();
      let e = t.getFullYear() - b.getFullYear();
      const m = t.getMonth() - b.getMonth();
      if (m < 0 || (m === 0 && t.getDate() < b.getDate())) e--;
      return e;
    }
    
    // Convertir SI/NO a booleanos
    const toBool = v => v === 'SI' ? true : v === 'NO' ? false : '';
    
    // Convertir a n√∫mero o dejar en blanco
    const numOrBlank = v => v !== '' ? Number(v) : '';
    
    // ===== Manejo de fecha de nacimiento formato dd/mm/yyyy =====
    function formatDateInput(input) {
      let value = input.replace(/\D/g, ''); // Solo n√∫meros
      if (value.length >= 2) {
        value = value.substring(0,2) + '/' + value.substring(2);
      }
      if (value.length >= 5) {
        value = value.substring(0,5) + '/' + value.substring(5,9);
      }
      return value;
    }
    
    function validateAndConvertDate(ddmmyyyy) {
      const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = ddmmyyyy.match(regex);
      
      if (!match) return null;
      
      const [, day, month, year] = match;
      const date = new Date(year, month - 1, day);
      
      // Verificar que la fecha es v√°lida
      if (date.getFullYear() != year || 
          date.getMonth() != (month - 1) || 
          date.getDate() != day) {
        return null;
      }
      
      // Verificar rango razonable (entre 1920 y hoy)
      const today = new Date();
      const minYear = 1920;
      if (date > today || parseInt(year) < minYear) {
        return null;
      }
      
      return {
        iso: year + '-' + month.padStart(2,'0') + '-' + day.padStart(2,'0'),
        date: date
      };
    }
    
    // Event listeners para fecha de nacimiento con toggle m√≥vil
    const textDateInput = document.getElementById('f_nacimiento');
    const calendarInput = document.getElementById('f_nacimiento_date');
    const isoHidden = document.getElementById('f_nacimiento_iso');
    const edadInput = document.getElementById('edad');
    const toggleButton = document.getElementById('date-mode-toggle');
    const modeHint = document.getElementById('date-mode-hint');
    
    let isCalendarMode = false;
    
    // Funci√≥n para convertir ISO a dd/mm/yyyy
    function isoToDisplayDate(isoDate) {
      if (!isoDate) return '';
      const [year, month, day] = isoDate.split('-');
      return `${day}/${month}/${year}`;
    }
    
    // Cambiar entre modo texto y calendario
    function toggleDateMode() {
      isCalendarMode = !isCalendarMode;
      
      if (isCalendarMode) {
        // Activar modo calendario
        calendarInput.style.pointerEvents = 'auto';
        calendarInput.style.opacity = '1';
        textDateInput.style.pointerEvents = 'none';
        textDateInput.style.opacity = '0.7';
        toggleButton.textContent = '‚úçÔ∏è';
        modeHint.textContent = 'üìÖ Modo calendario: Toca para seleccionar fecha';
      } else {
        // Activar modo texto
        calendarInput.style.pointerEvents = 'none';
        calendarInput.style.opacity = '0';
        textDateInput.style.pointerEvents = 'auto';
        textDateInput.style.opacity = '1';
        toggleButton.textContent = 'üìÖ';
        modeHint.textContent = '‚úçÔ∏è Modo texto: Escribe dd/mm/yyyy';
        textDateInput.focus();
      }
    }
    
    // Bot√≥n toggle
    toggleButton.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleDateMode();
    });
    
    // Formateo autom√°tico para input de texto
    textDateInput.addEventListener('input', (e) => {
      e.target.value = formatDateInput(e.target.value);
    });
    
    // Validaci√≥n cuando se sale del campo de texto
    textDateInput.addEventListener('blur', (e) => {
      const result = validateAndConvertDate(e.target.value);
      if (result) {
        isoHidden.value = result.iso;
        calendarInput.value = result.iso; // Sincronizar calendario
        const edad = calcEdad_(result.iso);
        edadInput.value = edad;
        e.target.style.borderColor = '#d9dce3'; // Reset border
      } else if (e.target.value) {
        e.target.style.borderColor = '#e53e3e'; // Error border
        isoHidden.value = '';
        calendarInput.value = '';
        edadInput.value = '';
      }
    });
    
    // Cuando se selecciona fecha del calendario
    calendarInput.addEventListener('change', (e) => {
      if (e.target.value) {
        const displayDate = isoToDisplayDate(e.target.value);
        textDateInput.value = displayDate;
        isoHidden.value = e.target.value;
        const edad = calcEdad_(e.target.value);
        edadInput.value = edad;
        textDateInput.style.borderColor = '#d9dce3';
        // Volver a modo texto despu√©s de seleccionar
        setTimeout(() => {
          isCalendarMode = true; // Para que toggleDateMode() cambie a texto
          toggleDateMode();
        }, 500);
      }
    });

    // ===== Env√≠o =====
    const statusEl = document.getElementById('status');
    const btnSubmit = document.getElementById('btnSubmit');
    
    function stopCamera_() {
      try {
        stream && stream.getTracks().forEach(t => t.stop());
      } catch(_) {}
    }
    
    btnSubmit.onclick = () => {
      const id_cliente = document.getElementById('idCliente').value;
      const clienteSel = document.getElementById('clienteSelect');
      const cliente = clienteSel.selectedOptions[0]?.textContent || '';

      const nombre_completo = document.getElementById('nombre_completo').value.trim();
      const documento_identidad = document.getElementById('documento_identidad').value.trim();
      const rh = document.getElementById('rh').value;
      const f_nacimiento = document.getElementById('f_nacimiento').value;
      const f_nacimiento_iso = document.getElementById('f_nacimiento_iso').value;
      
      // ===== VALIDACI√ìN COMPLETA DE TODOS LOS CAMPOS OBLIGATORIOS =====
      const missingFields = [];
      const fieldLabels = {
        'clienteSelect': 'Cliente',
        'nombre_completo': 'Nombre completo', 
        'documento_identidad': 'Documento de identidad',
        'f_nacimiento': 'Fecha de nacimiento',
        'email': 'Email',
        'telefono': 'Tel√©fono',
        'direccion_residencia': 'Direcci√≥n',
        'eps': 'EPS',
        'rh': 'Tipo de sangre (RH)',
        'peso': 'Peso (kg)',
        'estatura': 'Estatura (cm)',
        'edad': 'Edad',
        'enfermedades_importantes': 'Enfermedades importantes',
        'medicamentos': 'Medicamentos',
        'restricciones_medicas': 'Restricciones m√©dicas',
        'deporte_semana': 'Deportes y horas por semana'
      };
      
      // Validar campos b√°sicos
      Object.keys(fieldLabels).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        let isEmpty = false;
        
        // Validaci√≥n especial para fecha de nacimiento
        if (fieldId === 'f_nacimiento') {
          isEmpty = !f_nacimiento_iso; // Usar el campo ISO convertido
        } else {
          isEmpty = !field || !field.value.trim();
        }
        
        if (isEmpty) {
          missingFields.push(fieldLabels[fieldId]);
          if (field) field.style.borderColor = '#e53e3e'; // Marcar en rojo
        } else if (field) {
          field.style.borderColor = '#d9dce3'; // Reset
        }
      });
      
      // Validar cuestionario m√©dico - TODAS las preguntas son obligatorias
      const medicalQuestions = [
        { id: 'cardiaca', label: '¬øProblemas card√≠acos?' },
        { id: 'pechoactividad', label: '¬øDolor en el pecho durante actividad?' },
        { id: 'dolorpecho', label: '¬øDolor en el pecho en reposo?' },
        { id: 'conciencia', label: '¬øP√©rdida de conciencia?' },
        { id: 'huesos', label: '¬øProblemas en huesos o articulaciones?' },
        { id: 'medicamentos_bool', label: '¬øMedicamentos para presi√≥n/diabetes/coraz√≥n?' },
        { id: 'actividadfisica', label: '¬øActividad f√≠sica contraindicada?' },
        { id: 'convulsiones', label: '¬øConvulsiones?' },
        { id: 'vertigo', label: '¬øV√©rtigo?' },
        { id: 'oidos', label: '¬øProblemas de o√≠dos?' },
        { id: 'lugarescerrados', label: '¬øMiedo a lugares cerrados?' },
        { id: 'miedoalturas', label: '¬øMiedo a las alturas?' },
        { id: 'haceejercicio', label: '¬øHace ejercicio regularmente?' },
        { id: 'miedo_ver_sangre', label: '¬øMiedo a ver sangre?' }
      ];
      
      medicalQuestions.forEach(q => {
        const field = document.getElementById(q.id);
        if (field && !field.value) {
          missingFields.push(q.label);
          field.style.borderColor = '#e53e3e';
        } else if (field) {
          field.style.borderColor = '#d9dce3';
        }
      });
      
      // Validar foto
      if (!photoDataUrl) {
        missingFields.push('Foto del brigadista');
      }
      
      // Validar firma
      if (!signaturePad || signaturePad.isEmpty()) {
        missingFields.push('Firma');
      }
      
      // Mostrar campos faltantes
      if (missingFields.length > 0) {
        const message = `Faltan los siguientes campos obligatorios:\n\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}\n\nPor favor completa todos los campos para continuar.`;
        alert(message);
        return;
      }
      
      // Validaciones espec√≠ficas despu√©s de verificar que existen
      
      // VALIDACI√ìN DOCUMENTO: Solo n√∫meros enteros, sin puntos ni comas
      if (!/^\d+$/.test(documento_identidad) || documento_identidad <= 0) {
        alert('El documento de identidad debe ser un n√∫mero entero v√°lido (sin puntos, comas o letras).\n\nEjemplos v√°lidos: 12345678, 1234567890\nEjemplos inv√°lidos: 12.345.678, 12,345,678, abc123');
        document.getElementById('documento_identidad').style.borderColor = '#e53e3e';
        return;
      }
      
      // VALIDACI√ìN TEL√âFONO: Exactamente 10 d√≠gitos
      const telefono = document.getElementById('telefono').value.trim();
      if (!/^\d{10}$/.test(telefono)) {
        alert('El tel√©fono debe tener exactamente 10 d√≠gitos.\n\nEjemplo v√°lido: 3001234567\nEjemplos inv√°lidos: 300-123-4567, 300 123 4567, 123456789');
        document.getElementById('telefono').style.borderColor = '#e53e3e';
        return;
      }
      
      // VALIDACI√ìN EMAIL: Formato de email v√°lido
      const email = document.getElementById('email').value.trim();
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(email)) {
        alert('El email debe tener un formato v√°lido.\n\nEjemplos v√°lidos: nombre@empresa.com, juan.perez@gmail.com\nEjemplos inv√°lidos: nombre@, @empresa.com, nombre.empresa');
        document.getElementById('email').style.borderColor = '#e53e3e';
        return;
      }
      
      if (rh && !/^(O|A|B|AB)[+-]$/.test(rh)) {
        alert('Tipo de sangre inv√°lido.');
        document.getElementById('rh').style.borderColor = '#e53e3e';
        return;
      }
      
      if (f_nacimiento && !f_nacimiento_iso) {
        alert('Formato de fecha inv√°lido. Use el formato dd/mm/yyyy (ejemplo: 15/03/1990).');
        document.getElementById('f_nacimiento').style.borderColor = '#e53e3e';
        return;
      }

      const payload = {
        // m√≠nimos obligatorios
        id_cliente,
        cliente,
        nombre_completo,
        documento_identidad,

        // resto de campos
        f_nacimiento: f_nacimiento_iso || '',
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        direccion_residencia: document.getElementById('direccion_residencia').value,
        edad: numOrBlank(document.getElementById('edad').value) || calcEdad_(f_nacimiento_iso),
        eps: document.getElementById('eps').value,
        rh: document.getElementById('rh').value,
        peso: numOrBlank(document.getElementById('peso').value),
        estatura: numOrBlank(document.getElementById('estatura').value),
        
        // estudios (array din√°mico)
        estudios: collectEstudiosData(),
        
        // salud
        enfermedades_importantes: document.getElementById('enfermedades_importantes').value,
        medicamentos: document.getElementById('medicamentos').value,
        
        // cuestionario m√©dico (convertido a booleanos)
        cardiaca: toBool(document.getElementById('cardiaca').value),
        pechoactividad: toBool(document.getElementById('pechoactividad').value),
        dolorpecho: toBool(document.getElementById('dolorpecho').value),
        conciencia: toBool(document.getElementById('conciencia').value),
        huesos: toBool(document.getElementById('huesos').value),
        medicamentos_bool: toBool(document.getElementById('medicamentos_bool').value),
        actividadfisica: toBool(document.getElementById('actividadfisica').value),
        convulsiones: toBool(document.getElementById('convulsiones').value),
        vertigo: toBool(document.getElementById('vertigo').value),
        oidos: toBool(document.getElementById('oidos').value),
        lugarescerrados: toBool(document.getElementById('lugarescerrados').value),
        miedoalturas: toBool(document.getElementById('miedoalturas').value),
        haceejercicio: toBool(document.getElementById('haceejercicio').value),
        miedo_ver_sangre: toBool(document.getElementById('miedo_ver_sangre').value),
        restricciones_medicas: document.getElementById('restricciones_medicas').value,
        deporte_semana: document.getElementById('deporte_semana').value,

        // multimedia
        photoDataUrl: photoDataUrl || '',
        signatureDataUrl: (signaturePad && !signaturePad.isEmpty()) ? signaturePad.toDataURL('image/png') : '',

        // utilidades
        fecha_inscripcion: new Date().toISOString().slice(0,10) // YYYY-MM-DD
      };

      // Prevenir doble env√≠o
      btnSubmit.disabled = true;
      statusEl.textContent = 'Enviando‚Ä¶';
      
      google.script.run
        .withSuccessHandler((res) => {
          statusEl.textContent = res?.ok ? '¬°Enviado! ‚úÖ' : 'Error al guardar';
          btnSubmit.disabled = false;
          stopCamera_();
          // (Opcional) limpiar formulario:
          // document.querySelector('form')?.reset();
          // signaturePad.clear(); photoDataUrl=''; photoCanvas.style.display='none';
        })
        .withFailureHandler(err => {
          statusEl.textContent = 'Error: ' + err;
          btnSubmit.disabled = false;
          stopCamera_();
        })
        .saveSubmission(payload);
    };

    // ===== Gesti√≥n de estudios din√°micos - NUEVO DISE√ëO =====
    function addEstudioRecord() {
      const container = document.getElementById('estudios-container');
      const addButton = document.getElementById('btn-add-estudio');
      
      const recordDiv = document.createElement('div');
      recordDiv.className = 'estudio-record';
      
      recordDiv.innerHTML = `
        <button type="button" class="btn-remove-estudio">√ó</button>
        
        <div>
          <label>üìö ¬øQu√© estudi√≥?</label>
          <input class="estudio-nombre" placeholder="Ej: Primeros Auxilios, Rescate en Alturas, Bombero..." />
        </div>
        
        <div>
          <label>üè¢ ¬øD√≥nde lo estudi√≥?</label>
          <input class="estudio-institucion" placeholder="Ej: Cruz Roja, Defensa Civil, SENA, Universidad..." />
        </div>
        
        <div>
          <label>üìÖ ¬øEn qu√© a√±o?</label>
          <input class="estudio-anio" type="number" placeholder="Ej: 2020" min="1950" max="2030" />
        </div>
      `;
      
      container.insertBefore(recordDiv, addButton);
      
      const removeBtn = recordDiv.querySelector('.btn-remove-estudio');
      removeBtn.addEventListener('click', () => {
        recordDiv.remove();
      });
    }
    
    function collectEstudiosData() {
      const records = document.querySelectorAll('.estudio-record');
      const estudios = [];
      
      records.forEach(record => {
        const nombre = record.querySelector('.estudio-nombre').value.trim();
        const institucion = record.querySelector('.estudio-institucion').value.trim();
        const anio = record.querySelector('.estudio-anio').value;
        
        if (nombre || institucion || anio) {
          estudios.push({
            nombre: nombre,
            institucion: institucion,
            anio: anio ? Number(anio) : ''
          });
        }
      });
      
      return estudios;
    }

    // init
    window.addEventListener('load', () => {
      cargarClientes();
      initSignature();
      
      document.getElementById('btn-add-estudio').addEventListener('click', addEstudioRecord);
      
      document.querySelectorAll('.btn-remove-estudio').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.estudio-record').remove();
        });
      });
    });
  </script>
</body>
</html>

**********************************************************
/***** CONFIG *****/
const SHEET_ID = '1wkgmYrqLmNKnz0ve70MzWU8gegqPZaeQYgOi7j4tA4A';
const SH_RESPUESTAS = 'HV_BRIGADISTA';
const SH_CLIENTES   = 'tbl_clientes';

const IMAGES_FOLDER_ID   = '1vB9kk4a53uDSxZPsSMrW_jxrWW4lwGKJ';
const IMAGES_FOLDER_NAME = 'HV_BRIGADISTA_Images';

// Email notification settings
const NOTIFICATION_EMAILS = [
  'eleyson.segura@cycloidtalent.com',
  'edison.cuervo@cycloidtalent.com'
];


/***** WEB APP *****/
function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Hoja de Vida Brigadista');
}

/***** DROPDOWN: clientes activos (columna E = estado) *****/
function getActiveClients() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sh = ss.getSheetByName(SH_CLIENTES);
  if (!sh) return [];

  const values = sh.getDataRange().getValues();
  if (!values.length) return [];

  // normaliza encabezados a min√∫sculas
  const hdr = values[0].map(h => String(h).trim().toLowerCase());

  const idx = (nameArr, fallback = -1) => {
    for (const n of (Array.isArray(nameArr) ? nameArr : [nameArr])) {
      const i = hdr.indexOf(n);
      if (i >= 0) return i;
    }
    return fallback;
  };

  const ixId     = idx('id_cliente', 0); // si no existe, usa col A
  const ixName   = idx(['cliente', 'nombre_cliente', 'nombre', 'razon_social'], 1); // fallback col B
  const ixEstado = idx('estado', 4); // si no existe, asume col E

  return values.slice(1)
    .filter(r => String(r[ixEstado] || '').trim().toLowerCase() === 'activo')
    .map(r => ({ id: r[ixId], name: r[ixName] }))
    .filter(c => c.id && c.name)
    .sort((a,b) => String(a.name).localeCompare(String(b.name), 'es'));
}

/***** GUARDAR ENV√çO *****/
function saveSubmission(payload) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000);
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sh = ss.getSheetByName(SH_RESPUESTAS);

    // guardar im√°genes ‚Üí rutas relativas
    const { fotoRelPath, firmaRelPath } = saveImagesIfAny_(payload);

    // normalizar fechas/n√∫meros
    const toDate = v => v ? new Date(v) : '';
    const now = new Date();

    // procesar estudios din√°micos
    const estudios = payload.estudios || [];
    const estudio1 = estudios[0] || {};
    const estudio2 = estudios[1] || {};
    const estudio3 = estudios[2] || {};

    // escribe por NOMBRE de columna (no depende del orden)
    const newId = payload.ID || generateNextId_();
    appendByHeader_(sh, {
      'ID'                    : newId,
      'fecha_registro'        : payload.fecha_registro ? toDate(payload.fecha_registro) : now,
      'fecha_inscripcion'     : payload.fecha_inscripcion ? toDate(payload.fecha_inscripcion) : '',
      'foto_brigadista'       : fotoRelPath,
      'nombre_completo'       : payload.nombre_completo || '',
      'documento_identidad'   : payload.documento_identidad || '',
      'f_nacimiento'          : toDate(payload.f_nacimiento),
      'email'                 : payload.email || '',
      'telefono'              : payload.telefono || '',
      'direccion_residencia'  : payload.direccion_residencia || '',
      'edad'                  : payload.edad ?? '',
      'eps'                   : payload.eps || '',
      'peso'                  : payload.peso ?? '',
      'estatura'              : payload.estatura ?? '',
      'rh'                    : payload.rh || '',

      'estudios_1'            : estudio1.nombre || '',
      'estudios_2'            : estudio2.nombre || '',
      'estudios_3'            : estudio3.nombre || '',
      'lugar_estudio_1'       : estudio1.institucion || '',
      'lugar_estudio_2'       : estudio2.institucion || '',
      'lugar_estudio_3'       : estudio3.institucion || '',
      'anio_estudio_1'        : estudio1.anio ?? '',
      'anio_estudio_2'        : estudio2.anio ?? '',
      'anio_estudio_3'        : estudio3.anio ?? '',

      'enfermedades_importantes': payload.enfermedades_importantes || '',
      'medicamentos'             : payload.medicamentos || '',  // texto libre (una sola vez)

      // cuestionario (convertidos a SI/NO)
      'cardiaca'            : siNo_(payload.cardiaca),
      'pechoactividad'      : siNo_(payload.pechoactividad),
      'dolorpecho'          : siNo_(payload.dolorpecho),
      'conciencia'          : siNo_(payload.conciencia),
      'huesos'              : siNo_(payload.huesos),
      'medicamentos_bool'   : siNo_(payload.medicamentos_bool),
      'actividadfisica'     : siNo_(payload.actividadfisica),
      'convulsiones'        : siNo_(payload.convulsiones),
      'vertigo'             : siNo_(payload.vertigo),
      'oidos'               : siNo_(payload.oidos),
      'lugarescerrados'     : siNo_(payload.lugarescerrados),
      'miedoalturas'        : siNo_(payload.miedoalturas),
      'haceejercicio'       : siNo_(payload.haceejercicio),
      'miedo_ver_sangre'    : siNo_(payload.miedo_ver_sangre),

      'restricciones_medicas': payload.restricciones_medicas || '',
      'deporte_semana'       : payload.deporte_semana || '',

      'firma'                : firmaRelPath,
      'id_cliente'           : payload.id_cliente || '',
      'cliente'              : payload.cliente || '',
      'TriggerStamp'         : '',        // se setea enseguida en la fila creada
      'pdf_url'              : ''  // lo llenar√° AppSheet
    });

    // 1) Marcar TriggerStamp en la fila reci√©n insertada
    const lastRow = sh.getLastRow();
    const hdr = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
    const ixTrig = hdr.indexOf('TriggerStamp') + 1;
    const triggerValue = new Date(); // DateTime real
    if (ixTrig > 0) {
      sh.getRange(lastRow, ixTrig).setValue(triggerValue);
    }

    // 2) (Opcional) Llamar API de AppSheet para asegurar disparo inmediato
    try {
      callAppSheetEdit_V2(
        { appId: 'd47ca018-9c01-44b3-b8f5-1edd4e4df137',
          accessKey: 'V2-fnR2P-IIBNz-WW0sH-LE86P-6n2JN-fSMHS-1J0iR-E1x7e',
          table: 'HV_BRIGADISTA' },
        newId,
        triggerValue
      );
    } catch (_) {}

    // 3) Enviar notificaci√≥n por email
    try {
      sendRegistrationNotification_(payload, newId);
    } catch (emailErr) {
      console.log(`Error enviando email: ${emailErr}`);
      // No fallar el registro por error de email
    }

    return { ok: true, id: newId, fotoRelPath, firmaRelPath };

  } catch (err) {
    return { ok: false, error: String(err) };
  } finally {
    lock.releaseLock();
  }
}

/***** UTILIDADES *****/
function appendByHeader_(sheet, obj) {
  const lastCol = sheet.getLastColumn();
  const hdr = sheet.getRange(1,1,1,lastCol).getValues()[0];
  const row = hdr.map(col => (col in obj ? obj[col] : ''));
  sheet.appendRow(row);
}

function siNo_(v) {
  // Convierte true/false/"SI"/"NO"/"" ‚Üí "SI"/"NO"/""
  if (v === true || String(v).toUpperCase() === 'SI') return 'SI';
  if (v === false || String(v).toUpperCase() === 'NO') return 'NO';
  return v === '' || v == null ? '' : (String(v).toUpperCase() === 'TRUE' ? 'SI' :
                                       String(v).toUpperCase() === 'FALSE' ? 'NO' : String(v));
}

function generateNextId_() {
  // ID como HVB-YYYYMM-#### con contador persistente
  const props = PropertiesService.getScriptProperties();
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const key = `CTR_${y}${m}`;
  const cur = Number(props.getProperty(key) || '0') + 1;
  props.setProperty(key, String(cur));
  return `HVB-${y}${m}-${String(cur).padStart(4, '0')}`;
}

function saveImagesIfAny_(payload) {
  const folder = DriveApp.getFolderById(IMAGES_FOLDER_ID);
  const ts = new Date().toISOString().replace(/[-:.TZ]/g,'');
  const base = (payload.documento_identidad || 'brigadista') + '_' + ts;

  let fotoRelPath = '', firmaRelPath = '';

  if (payload.photoDataUrl) {
    const blob = dataUrlToBlob_(payload.photoDataUrl, base + '_FOTO.png');
    const file = folder.createFile(blob);
    fotoRelPath = `${IMAGES_FOLDER_NAME}/${file.getName()}`;
  }
  if (payload.signatureDataUrl) {
    const blob = dataUrlToBlob_(payload.signatureDataUrl, base + '_FIRMA.png');
    const file = folder.createFile(blob);
    firmaRelPath = `${IMAGES_FOLDER_NAME}/${file.getName()}`;
  }
  return { fotoRelPath, firmaRelPath };
}

function dataUrlToBlob_(dataUrl, name) {
  const base64 = (dataUrl || '').split(',')[1] || '';
  return Utilities.newBlob(Utilities.base64Decode(base64), 'image/png', name);
}

function callAppSheetEdit_V2(cfg, id, triggerValue) {
  // Sanidad de tipos
  const rowId = String(id);
  const trig  = (triggerValue instanceof Date) ? triggerValue.toISOString() : String(triggerValue);

  console.log('V2 args', { rowId, trig, cfg });

  const url = `https://api.appsheet.com/api/v2/apps/${cfg.appId}/tables/${encodeURIComponent(cfg.table)}/Action`;
  const payload = {
    Action: "Edit",
    Properties: { Locale: "es-ES", Timezone: "America/Bogota" },
    Rows: [{ ID: rowId, TriggerStamp: trig }]
  };

  const res = UrlFetchApp.fetch(url, {
    method: 'post',
    headers: { 'ApplicationAccessKey': cfg.accessKey },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });

  console.log('V2 status', res.getResponseCode(), 'body', res.getContentText());
}

function callAppSheetEdit_V2_batch(cfg, items) {
  const url = `https://api.appsheet.com/api/v2/apps/${cfg.appId}/tables/${encodeURIComponent(cfg.table)}/Action`;
  const payload = {
    Action: "Edit",
    Properties: { Locale: "es-ES", Timezone: "America/Bogota" },
    Rows: items.map(it => ({ ID: String(it.id), TriggerStamp: String(it.trig) }))
  };
  const res = UrlFetchApp.fetch(url, {
    method: 'post',
    headers: { 'ApplicationAccessKey': cfg.accessKey },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });
  console.log('V2 batch status', res.getResponseCode(), 'body', res.getContentText());
}

/***** EMAIL NOTIFICATIONS *****/
function sendRegistrationNotification_(payload, registroId) {
  const subject = `üö® Nuevo Registro de Brigadista - ID: ${registroId}`;
  
  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <div style="background: linear-gradient(135deg, #ff6100, #ff8c42); color: white; padding: 20px; border-radius: 10px 10px 0 0;">
        <h2 style="margin: 0;">üÜï Nuevo Registro de Brigadista</h2>
        <p style="margin: 5px 0 0 0; opacity: 0.9;">Sistema HV_BRIGADISTA</p>
      </div>
      
      <div style="background: #f8f9fc; padding: 20px; border-radius: 0 0 10px 10px; border: 1px solid #e5e7eb;">
        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h3 style="color: #1f2937; margin-top: 0;">üìã Datos del Registro</h3>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="margin: 8px 0;"><strong>üÜî ID:</strong> ${registroId}</li>
            <li style="margin: 8px 0;"><strong>üë§ Nombre:</strong> ${payload.nombre_completo || 'No especificado'}</li>
            <li style="margin: 8px 0;"><strong>üìÑ Documento:</strong> ${payload.documento_identidad || 'No especificado'}</li>
            <li style="margin: 8px 0;"><strong>üè¢ Cliente:</strong> ${payload.cliente || 'No especificado'}</li>
            <li style="margin: 8px 0;"><strong>üìß Email:</strong> ${payload.email || 'No especificado'}</li>
            <li style="margin: 8px 0;"><strong>üì± Tel√©fono:</strong> ${payload.telefono || 'No especificado'}</li>
            <li style="margin: 8px 0;"><strong>üìÖ Fecha Registro:</strong> ${new Date().toLocaleString('es-CO')}</li>
          </ul>
        </div>
        
        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; border-left: 4px solid #0288d1;">
          <h4 style="color: #01579b; margin-top: 0;">üìä Informaci√≥n Adicional</h4>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="margin: 5px 0;"><strong>ü©∏ RH:</strong> ${payload.rh || 'No especificado'}</li>
            <li style="margin: 5px 0;"><strong>üè• EPS:</strong> ${payload.eps || 'No especificado'}</li>
            <li style="margin: 5px 0;"><strong>üì∏ Foto:</strong> ${payload.photoDataUrl ? '‚úÖ Adjunta' : '‚ùå No adjunta'}</li>
            <li style="margin: 5px 0;"><strong>‚úçÔ∏è Firma:</strong> ${payload.signatureDataUrl ? '‚úÖ Adjunta' : '‚ùå No adjunta'}</li>
          </ul>
        </div>
        
        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #9c27b0;">
          <h4 style="color: #6a1b9a; margin-top: 0;">üéØ Pr√≥ximos Pasos</h4>
          <p style="margin: 0; color: #4a148c;">
            ‚úÖ El registro ha sido guardado exitosamente en la base de datos<br>
            ‚úÖ AppSheet ha sido notificado autom√°ticamente<br>
            üìã Revisar el formulario en el sistema AppSheet para validaci√≥n final
          </p>
        </div>
        
        <div style="text-align: center; margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
          <a href="https://docs.google.com/spreadsheets/d/${SHEET_ID}" 
             style="background: #ff6100; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">
            üìä Ver Hoja de C√°lculo
          </a>
        </div>
        
        <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #6b7280;">
          <p>ü§ñ Notificaci√≥n autom√°tica del Sistema HV_BRIGADISTA</p>
          <p>üìÖ ${new Date().toLocaleString('es-CO', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}</p>
        </div>
      </div>
    </div>
  `;

  // Enviar a todos los emails configurados
  NOTIFICATION_EMAILS.forEach(email => {
    try {
      MailApp.sendEmail({
        to: email,
        subject: subject,
        htmlBody: htmlBody
      });
      console.log(`Email enviado exitosamente a: ${email}`);
    } catch (err) {
      console.log(`Error enviando email a ${email}: ${err}`);
    }
  });
}

/***** TRIGGER INSTALABLE: On edit (desde el Spreadsheet) *****/
function onEdit(e) {
  try {
    if (!e || !e.range) return;
    const sh = e.range.getSheet();
    if (sh.getName() !== SH_RESPUESTAS) return;

    const row = e.range.getRow();
    const col = e.range.getColumn();
    if (row === 1) return;

    const lastCol = sh.getLastColumn();
    const headers = sh.getRange(1,1,1,lastCol).getValues()[0].map(h => String(h).trim());
    const ixID = headers.indexOf('ID') + 1;
    const ixTR = headers.indexOf('TriggerStamp') + 1;
    if (ixID === 0 || ixTR === 0) return;

    // Si editaron cualquier columna distinta a TriggerStamp ‚Üí refresca TriggerStamp
    if (col !== ixTR) {
      sh.getRange(row, ixTR).setValue(new Date());
      SpreadsheetApp.flush();
    }

    detectAndProcessChanges();
  } catch (err) {
    console.log('onEdit error:', err);
  }
}

function checkNewRows(e) {
  if (e && e.changeType && e.changeType === 'FORMAT') return; // ignora solo formato
  detectAndProcessChanges();
}

function detectAndProcessChanges() {
  const lock = LockService.getScriptLock();
  if (!lock.tryLock(5000)) {
    console.log('detectAndProcessChanges: no pudo adquirir lock');
    return;
  }
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sh = ss.getSheetByName(SH_RESPUESTAS);
    if (!sh) return;

    const values = sh.getDataRange().getValues();
    if (values.length < 2) return;

    const hdr = values[0].map(h => String(h).trim());
    const ixID = hdr.indexOf('ID');
    const ixTR = hdr.indexOf('TriggerStamp');
    if (ixID === -1 || ixTR === -1) {
      console.log('No se encontraron columnas ID o TriggerStamp');
      return;
    }

    const trigState = readState_();
    const toProcess = [];
    const newTrigState = { ...trigState };

    for (let r = 1; r < values.length; r++) {
      const id = String(values[r][ixID] || '').trim();
      if (!id) continue;

      const trigValue = values[r][ixTR];
      let trig = trigValue instanceof Date
        ? trigValue.toISOString()
        : String(trigValue || '').trim();

      // Si no hay TriggerStamp en la hoja, genera uno ef√≠mero para AppSheet
      if (!trig) trig = new Date().toISOString();

      const prevTrig = trigState[id];

      if (!prevTrig) {
        console.log(`ID nuevo detectado: ${id}`);
        toProcess.push({ id, trig });
        newTrigState[id] = trig;
      } else if (trig !== prevTrig) {
        console.log(`TriggerStamp cambi√≥ para ${id}: ${prevTrig} -> ${trig}`);
        toProcess.push({ id, trig });
        newTrigState[id] = trig;
      }
    }

    if (toProcess.length > 0) {
      console.log(`Procesando ${toProcess.length} cambios detectados`);

      try {
        callAppSheetEdit_V2_batch(
          { appId: 'd47ca018-9c01-44b3-b8f5-1edd4e4df137',
            accessKey: 'V2-fnR2P-IIBNz-WW0sH-LE86P-6n2JN-fSMHS-1J0iR-E1x7e',
            table: 'HV_BRIGADISTA' },
          toProcess
        );
      } catch (err) {
        console.log(`Error en llamada batch: ${err}`);
      }

      writeState_(newTrigState);
    } else {
      console.log('No se detectaron cambios que procesar');
    }
  } catch (err) {
    console.log(`Error en detectAndProcessChanges: ${err}`);
  } finally {
    lock.releaseLock();
  }
}

function readState_() {
  const props = PropertiesService.getScriptProperties();
  const stateJson = props.getProperty('HV_BRIGADISTA_TRIGGER_STATE') || '{}';
  try {
    return JSON.parse(stateJson);
  } catch (err) {
    console.log(`Error leyendo estado: ${err}`);
    return {};
  }
}

function writeState_(trigState) {
  const props = PropertiesService.getScriptProperties();
  try {
    props.setProperty('HV_BRIGADISTA_TRIGGER_STATE', JSON.stringify(trigState));
  } catch (err) {
    console.log(`Error guardando estado: ${err}`);
  }
}

/***** FUNCIONES DE PRUEBA Y UTILIDADES *****/
function testTriggerDetection() {
  console.log('=== PRUEBA DE DETECCI√ìN DE CAMBIOS ===');
  
  // mostrar estado actual
  const currentState = readState_();
  console.log('Estado actual:', currentState);
  
  // ejecutar detecci√≥n
  detectAndProcessChanges();
  
  // mostrar estado despu√©s
  const newState = readState_();
  console.log('Nuevo estado:', newState);
}

function clearTriggerState() {
  console.log('Limpiando estado de triggers...');
  const props = PropertiesService.getScriptProperties();
  props.deleteProperty('HV_BRIGADISTA_TRIGGER_STATE');
  console.log('Estado limpiado');
}

function showCurrentTriggerState() {
  const state = readState_();
  console.log('Estado actual de triggers:');
  console.log(JSON.stringify(state, null, 2));
  return state;
}

*********************************************************
/**
 * Detecta nuevas filas (de Jotform) en la hoja de respuestas
 * y dispara el Bot de AppSheet marcando Trigger con un valor √∫nico.
 *
 * CONFIGURA los valores en la secci√≥n CONFIG.
 * Crea un TRIGGER instalable: From spreadsheet -> On change -> run checkNewRows
 * 
 * VERSION CON LOGS DETALLADOS PARA DEBUG
 * Revisa el Log de Ejecuci√≥n en Apps Script para ver todos los detalles
 */

//////////////////// CONFIG ////////////////////
const CFG = {
  SHEET_NAME: 'HV_BRIGADISTA',
  HEADER_SUBMISSION_ID: 'ID',          // ‚Üê antes: 'Submission ID'
  HEADER_TRIGGER: 'TriggerStamp',

  APP_ID: 'd47ca018-9c01-44b3-b8f5-1edd4e4df137',
  ACCESS_KEY: 'V2-fnR2P-IIBNz-WW0sH-LE86P-6n2JN-fSMHS-1J0iR-E1x7e',
  TABLE_NAME: 'HV_BRIGADISTA',         // ‚Üê antes: 'Form responses brigadistas'
  LOCALE: 'es-ES',
  TIMEZONE: 'America/Bogota',
  STATE_KEY: 'last_processed_submission_id',

  ENABLE_ULTRA_VERBOSE_LOGS: true,
  LOG_PREFIX: 'üî• ULTRA-DEBUG',
  LOG_SEPARATOR: '‚ïê'.repeat(80)
};
////////////////////////////////////////////////

/**
 * Busca una columna por su encabezado en la primera fila
 * @param {Sheet} sheet - La hoja donde buscar
 * @param {string} headerText - El texto del encabezado a buscar
 * @returns {number|null} - N√∫mero de columna (1-indexed) o null si no se encuentra
 */
function findColumnByHeaderOLD_(sheet, headerText) {
  console.log(`--- BUSCANDO COLUMNA POR ENCABEZADO: "${headerText}" ---`);
  
  try {
    const lastCol = sheet.getLastColumn();
    console.log('√öltima columna con datos:', lastCol);
    
    if (lastCol === 0) {
      console.log('No hay columnas con datos');
      return null;
    }
    
    // Lee toda la primera fila (encabezados)
    const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    console.log('Encabezados encontrados:', headers.length);
    console.log('Primeros 10 encabezados:', headers.slice(0, 10));
    
    // Busca el encabezado exacto
    for (let i = 0; i < headers.length; i++) {
      const header = String(headers[i] || '').trim();
      console.log(`Columna ${i + 1}: "${header}" ${header === headerText ? '‚Üê MATCH!' : ''}`);
      
      if (header === headerText) {
        console.log(`‚úì Encabezado "${headerText}" encontrado en columna ${i + 1}`);
        return i + 1; // Retorna 1-indexed
      }
    }
    
    console.log(`‚ùå Encabezado "${headerText}" NO encontrado`);
    console.log('Encabezados disponibles:');
    headers.forEach((h, i) => console.log(`  ${i + 1}: "${String(h || '').trim()}"`));
    
    return null;
    
  } catch (err) {
    console.error('Error buscando columna por encabezado:', err.message);
    return null;
  }
}

/**
 * Obtiene los n√∫meros de columna bas√°ndose en los encabezados configurados
 * @param {Sheet} sheet - La hoja donde buscar
 * @returns {Object} - Objeto con las columnas encontradas
 */
function getColumnNumbersOLD_(sheet) {
  console.log('--- DETECTANDO COLUMNAS AUTOM√ÅTICAMENTE ---');
  
  const columns = {
    submissionId: findColumnByHeaderOLD_(sheet, CFG.HEADER_SUBMISSION_ID),
    trigger: findColumnByHeaderOLD_(sheet, CFG.HEADER_TRIGGER)
  };
  
  console.log('Columnas detectadas:');
  console.log(`- ${CFG.HEADER_SUBMISSION_ID}: columna ${columns.submissionId || 'NO ENCONTRADA'}`);
  console.log(`- ${CFG.HEADER_TRIGGER}: columna ${columns.trigger || 'NO ENCONTRADA'}`);
  
  // Validar que al menos ID fue encontrado
  if (!columns.submissionId) {
    throw new Error(`CR√çTICO: No se encontr√≥ la columna "${CFG.HEADER_SUBMISSION_ID}"`);
  }
  
  if (!columns.trigger) {
    console.warn(`ADVERTENCIA: No se encontr√≥ la columna "${CFG.HEADER_TRIGGER}". El trigger no se marcar√° en la hoja.`);
  }
  
  console.log('--- DETECCI√ìN DE COLUMNAS COMPLETADA ---');
  return columns;
}

// Funci√≥n auxiliar para debug manual
function testCheckNewRowsOLD() {
  console.log('üß™ EJECUTANDO TEST MANUAL');
  console.log('Simulando evento onChange...');
  
  const fakeEvent = {
    source: SpreadsheetApp.getActive(),
    range: null,
    authMode: 'FULL',
    triggerUid: 'MANUAL_TEST_' + new Date().getTime()
  };
  
  checkNewRowsOLD(fakeEvent);
  console.log('üß™ TEST MANUAL COMPLETADO');
}

// Funci√≥n para limpiar el estado (√∫til para testing)
function resetStateOLD() {
  console.log('üîÑ LIMPIANDO ESTADO...');
  const props = PropertiesService.getScriptProperties();
  const oldValue = props.getProperty(CFG.STATE_KEY);
  console.log('Valor anterior:', oldValue || 'NINGUNO');
  
  props.deleteProperty(CFG.STATE_KEY);
  console.log('‚úì Estado limpiado. Pr√≥xima ejecuci√≥n procesar√° el √∫ltimo submission.');
}

// Funci√≥n para revisar configuraci√≥n
function debugConfigOLD() {
  console.log('üîß REVISI√ìN DE CONFIGURACI√ìN:');
  console.log('CONFIG completa:', JSON.stringify(CFG, null, 2));
  
  // Validar acceso a la hoja
  try {
    const ss = SpreadsheetApp.getActive();
    console.log('‚úì Spreadsheet accesible:', ss.getName());
    
    const sh = ss.getSheetByName(CFG.SHEET_NAME);
    if (sh) {
      console.log('‚úì Hoja encontrada:', sh.getName());
      console.log('- √öltima fila:', sh.getLastRow());
      console.log('- √öltima columna:', sh.getLastColumn());
      
      // Probar detecci√≥n de columnas
      try {
        const columns = getColumnNumbersOLD_(sh);
        console.log('‚úì Detecci√≥n de columnas exitosa');
      } catch (colErr) {
        console.error('‚ùå Error en detecci√≥n de columnas:', colErr.message);
      }
    } else {
      console.error('‚ùå Hoja NO encontrada:', CFG.SHEET_NAME);
      console.log('Hojas disponibles:', ss.getSheets().map(s => s.getName()));
    }
  } catch (err) {
    console.error('‚ùå Error accediendo spreadsheet:', err.message);
  }
  
  // Revisar estado guardado
  const props = PropertiesService.getScriptProperties();
  const state = props.getProperty(CFG.STATE_KEY);
  console.log('Estado actual:', state || 'NINGUNO');
}

////////////////////////////////////////////////

function checkNewRowsOLD(e) {
  console.log('=== INICIO checkNewRows ===');
  console.log('Timestamp:', new Date().toISOString());
  console.log('Event objeto recibido:', JSON.stringify(e, null, 2));
  
  try {
    // Log configuraci√≥n
    console.log('CONFIG utilizada:');
    console.log('- SHEET_NAME:', CFG.SHEET_NAME);
    console.log('- HEADER_SUBMISSION_ID:', CFG.HEADER_SUBMISSION_ID);
    console.log('- HEADER_TRIGGER:', CFG.HEADER_TRIGGER);
    console.log('- APP_ID:', CFG.APP_ID);
    console.log('- TABLE_NAME:', CFG.TABLE_NAME);
    
    const ss = SpreadsheetApp.getActive();
    console.log('Spreadsheet ID:', ss.getId());
    console.log('Spreadsheet nombre:', ss.getName());
    
    const sh = ss.getSheetByName(CFG.SHEET_NAME);
    if (!sh) {
      console.error('ERROR CR√çTICO: No existe la hoja:', CFG.SHEET_NAME);
      console.log('Hojas disponibles:', ss.getSheets().map(s => s.getName()));
      throw new Error('No existe la hoja: ' + CFG.SHEET_NAME);
    }
    console.log('‚úì Hoja encontrada:', sh.getName());

    // Detectar columnas autom√°ticamente
    const columns = getColumnNumbersOLD_(sh);

    const lastRow = sh.getLastRow();
    console.log('√öltima fila con datos:', lastRow);
    if (lastRow <= 1) {
      console.log('SALIDA TEMPRANA: Solo hay encabezado (lastRow <= 1)');
      return;
    }

    // Log del rango que se va a leer
    console.log('Leyendo rango para IDs:');
    console.log('- Fila inicio: 2');
    console.log('- Columna:', columns.submissionId);
    console.log('- Num filas:', lastRow - 1);
    
    const ids = sh.getRange(2, columns.submissionId, lastRow - 1, 1)
                  .getValues()
                  .map(r => String(r[0] || '').trim())
                  .filter(Boolean);

    console.log('IDs encontrados (total):', ids.length);
    console.log('Primeros 5 IDs:', ids.slice(0, 5));
    console.log('√öltimos 5 IDs:', ids.slice(-5));

    if (ids.length === 0) {
      console.log('SALIDA TEMPRANA: No hay IDs v√°lidos');
      return;
    }

    const lastSubmissionId = ids[ids.length - 1];
    console.log('√öltimo ID en hoja:', lastSubmissionId);
    
    const props = PropertiesService.getScriptProperties();
    const prev = props.getProperty(CFG.STATE_KEY);
    console.log('√öltimo ID procesado anteriormente:', prev || 'NINGUNO');

    // Si ya procesamos este mismo ID, no hacemos nada
    if (prev && prev === lastSubmissionId) {
      console.log('SALIDA TEMPRANA: Nada nuevo. √öltimo procesado =', prev);
      return;
    }
    console.log('‚úì HAY NUEVO SUBMISSION PARA PROCESAR');

    // Busca la fila exacta del √∫ltimo submission
    console.log('Buscando fila exacta del ID:', lastSubmissionId);
    const rowIndex = findRowBySubmissionIdOLD_(sh, columns.submissionId, lastSubmissionId);
    if (!rowIndex) {
      console.error('ERROR: No se ubic√≥ la fila del ID', lastSubmissionId);
      return;
    }
    console.log('‚úì Fila encontrada:', rowIndex);

    // Marca Trigger en la hoja
    const triggerValue = 'New_' + new Date().getTime();
    console.log('Valor de trigger generado:', triggerValue);
    
    if (columns.trigger) {
      console.log('Marcando trigger en fila', rowIndex, 'columna', columns.trigger);
      sh.getRange(rowIndex, columns.trigger).setValue(triggerValue);
      console.log('‚úì Trigger marcado en hoja');
    } else {
      console.log('ADVERTENCIA: Columna Trigger no encontrada, no se marcar√° en la hoja');
    }

    // Llama a AppSheet API
    console.log('Iniciando llamada a AppSheet API...');
    callAppSheetEditOLD_(lastSubmissionId, triggerValue);

    // Guarda estado
    console.log('Guardando nuevo estado:', lastSubmissionId);
    props.setProperty(CFG.STATE_KEY, lastSubmissionId);
    console.log('‚úì Estado guardado');
    
    console.log('‚úì √âXITO: Procesado ID:', lastSubmissionId);
    console.log('=== FIN checkNewRows EXITOSO ===');

  } catch (err) {
    console.error('üí• ERROR CR√çTICO en checkNewRows:');
    console.error('Mensaje:', err.message);
    console.error('Stack:', err.stack);
    console.error('L√≠nea:', err.lineNumber || 'N/A');
    console.log('=== FIN checkNewRows CON ERROR ===');
  }
}

function callAppSheetEditOLD_(submissionId, triggerValue) {
  console.log('--- INICIO callAppSheetEdit_ ---');
  console.log('Par√°metros recibidos:');
  console.log('- submissionId:', submissionId);
  console.log('- triggerValue:', triggerValue);
  
  const url = `https://api.appsheet.com/api/v2/apps/${CFG.APP_ID}/tables/${encodeURIComponent(CFG.TABLE_NAME)}/Action`;
  console.log('URL construida:', url);
  console.log('ACCESS_KEY usado:', CFG.ACCESS_KEY ? CFG.ACCESS_KEY.substring(0, 10) + '...' : 'NO DEFINIDO');
  
  console.log('üîç DEBUG API:');
  console.log('APP_ID:', CFG.APP_ID);
  console.log('TABLE_NAME:', CFG.TABLE_NAME);
  console.log('URL completa:', url);
  
  const payload = {
    Action: "Edit",
    Properties: { Locale: CFG.LOCALE, Timezone: CFG.TIMEZONE },
    Rows: [
      {
        // IMPORTANTE: la propiedad aqu√≠ debe llamarse EXACTO como la Key en AppSheet.
        // La Key ahora es 'ID' (antes era "Submission ID"):
        "ID": submissionId,
        "TriggerStamp": triggerValue
      }
    ]
  };
  
  console.log('Payload JSON completo:');
  console.log(JSON.stringify(payload, null, 2));
  
  const requestOptions = {
    method: 'post',
    headers: { 'ApplicationAccessKey': CFG.ACCESS_KEY },
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  console.log('Headers de request:');
  console.log(JSON.stringify(requestOptions.headers, null, 2));
  
  console.log('üîç PAYLOAD COMPLETO:', JSON.stringify(payload, null, 2));
  console.log('üîç HEADERS:', JSON.stringify(requestOptions.headers));
  console.log('ContentType:', requestOptions.contentType);
  console.log('Method:', requestOptions.method);
  
  console.log('Ejecutando UrlFetchApp.fetch...');
  const startTime = new Date().getTime();
  
  try {
    const resp = UrlFetchApp.fetch(url, requestOptions);
    const endTime = new Date().getTime();
    const duration = endTime - startTime;
    
    console.log('‚úì Respuesta recibida en', duration, 'ms');
    console.log('HTTP Status Code:', resp.getResponseCode());
    console.log('Response Headers:');
    console.log(JSON.stringify(resp.getAllHeaders(), null, 2));
    
    const responseText = resp.getContentText();
    console.log('Response Body (raw):');
    console.log(responseText);
    
    // Intentar parsear como JSON para mejor legibilidad
    try {
      const responseJson = JSON.parse(responseText);
      console.log('Response Body (parsed JSON):');
      console.log(JSON.stringify(responseJson, null, 2));
    } catch (jsonErr) {
      console.log('Response no es JSON v√°lido');
    }
    
    // An√°lisis del c√≥digo de respuesta
    const statusCode = resp.getResponseCode();
    if (statusCode >= 200 && statusCode < 300) {
      console.log('‚úì √âXITO: Llamada API exitosa');
    } else if (statusCode >= 400 && statusCode < 500) {
      console.error('‚ùå ERROR CLIENTE (4xx):', statusCode);
      console.error('Posibles problemas: ACCESS_KEY inv√°lido, payload malformado, permisos, tabla no existe');
    } else if (statusCode >= 500) {
      console.error('‚ùå ERROR SERVIDOR (5xx):', statusCode);
      console.error('Problema en AppSheet, reintentar m√°s tarde');
    } else {
      console.warn('‚ö†Ô∏è C√≥digo de respuesta inusual:', statusCode);
    }
    
  } catch (fetchErr) {
    console.error('üí• ERROR CR√çTICO en UrlFetchApp.fetch:');
    console.error('Mensaje:', fetchErr.message);
    console.error('Stack:', fetchErr.stack);
  }
  
  console.log('--- FIN callAppSheetEdit_ ---');
}

function findRowBySubmissionIdOLD_(sh, col, id) {
  console.log('--- INICIO findRowBySubmissionId_ ---');
  console.log('Par√°metros:');
  console.log('- Hoja:', sh.getName());
  console.log('- Columna:', col);
  console.log('- ID buscado:', id);
  
  const last = sh.getLastRow();
  console.log('√öltima fila de la hoja:', last);
  
  if (last <= 1) {
    console.log('No hay datos para buscar (solo encabezado)');
    return null;
  }
  
  console.log('Leyendo rango para b√∫squeda:');
  console.log('- Desde fila 2 hasta fila', last);
  console.log('- Columna', col);
  
  const vals = sh.getRange(2, col, last - 1, 1).getValues();
  console.log('Valores le√≠dos (total):', vals.length);
  console.log('Primeras 3 filas:', vals.slice(0, 3).map(v => String(v[0]).trim()));
  
  for (let i = 0; i < vals.length; i++) {
    const cellValue = String(vals[i][0]).trim();
    console.log(`Fila ${i + 2}: "${cellValue}" ${cellValue === id ? '‚Üê MATCH!' : ''}`);
    
    if (cellValue === id) {
      const rowNumber = i + 2;
      console.log('‚úì ID encontrado en fila:', rowNumber);
      console.log('--- FIN findRowBySubmissionId_ EXITOSO ---');
      return rowNumber;
    }
  }
  
  console.log('‚ùå ID NO ENCONTRADO');
  console.log('--- FIN findRowBySubmissionId_ SIN RESULTADO ---');
  return null;
}
************************************************************