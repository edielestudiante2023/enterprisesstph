<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <br>
  <title>Hoja de Vida Brigadista</title>
  <style>
    /* Mobile-first approach */
    body{font-family:system-ui,Arial,sans-serif;background:#f6f7fb;margin:0;padding:0}
    .wrap{
      max-width:860px;
      margin:8px;
      padding:12px;
      background:#fff;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.08)
    }
    h1{margin:0 0 16px;font-size:1.4rem}
    h3{font-size:1.1rem;margin:0 0 12px}
    
    /* Grid - mobile first (single column) */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px
    }
    
    label{font-weight:600;font-size:.9rem;margin-top:8px;display:block}
    input,select,textarea{
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
      font-size:16px;
      box-sizing:border-box
    }
    
    /* Select2 mobile styles */
    .select2-container{width:100%!important}
    .select2-selection{
      min-height:48px!important;
      border:1px solid #ddd!important;
      border-radius:8px!important;
      font-size:16px!important
    }
    .select2-selection__rendered{padding:12px!important;line-height:22px!important}
    .select2-selection__arrow{height:46px!important}
    .select2-dropdown{font-size:16px!important}
    .select2-results__option{padding:12px!important}
    
    textarea{min-height:80px;resize:vertical}
    
    /* Responsive buttons */
    .row{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px
    }
    button{
      padding:14px 16px;
      border:0;
      border-radius:8px;
      background:#1a73e8;
      color:#fff;
      cursor:pointer;
      font-size:16px;
      font-weight:600;
      width:100%
    }
    button.secondary{background:#5f6368}
    button:active{transform:scale(0.98)}
    
    /* Media elements */
    video,canvas{width:100%;border-radius:8px;background:#000;max-height:400px}
    
    .section{margin-top:24px;padding-top:16px;border-top:1px dashed #e6e6e6}
    .sig{
      border:1px dashed #bbb;
      background:#fafafa;
      height:200px;
      touch-action:none;
      display:block;
      width:100%;
      box-sizing:border-box
    }
    .full{grid-column:1 / -1}
    .note{font-size:.85rem;color:#5f6368;line-height:1.4}
    #status{margin-top:12px;font-weight:700;padding:8px;border-radius:6px}
    
    /* Studies container mobile optimization */
    #estudios-container{
      border:1px solid #ddd;
      border-radius:8px;
      padding:12px;
      background:#fafafa;
      margin-top:12px
    }
    .estudio-record{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-bottom:16px;
      padding:12px;
      background:white;
      border-radius:6px;
      border:1px solid #e6e6e6
    }
    .estudio-record button{margin-top:8px}
    
    /* File input styling - DUPLICADO */
    input[type="file"]{
      padding:16px; /* DOBLE: de 8px a 16px */
      font-size:28px; /* DOBLE: de 14px a 28px */
      border:4px dashed #ddd; /* DOBLE: de 2px a 4px */
      background:#fafafa;
      border-radius: 16px; /* Agregado para consistencia */
      min-height: 120px; /* Agregado para mejor touch */
    }
    
    /* Desktop styles - mantener tama√±os grandes */
    @media (min-width: 768px) {
      .wrap{margin:24px auto;padding:20px}
      h1{font-size:1.8rem}
      .row{flex-direction:row;flex-wrap:wrap}
      button{width:auto;min-width:120px}
      .sig{height:180px}
      .estudio-record{
        grid-template-columns:1fr auto;
        align-items:end
      }
      .estudio-record button{margin-top:0}
      /* Mantener fuentes grandes incluso en desktop */
    }
    
    /* Large desktop */
    @media (min-width: 1024px) {
      .wrap{margin:24px auto}
      h1{font-size:2rem}
    }

    /* ===== JOTFORM‚ÄëLIKE MOBILE THEME (overrides) ===== */
    :root{
      --radius:16px;
      --pad:14px;
      --fieldH:60px;
      --font: clamp(18px, 3.2vw, 20px);
      --font-sm: clamp(16px, 2.8vw, 18px);
      --brand:#ff6100;
      --brand-light:#ff7900;
      --brand-gradient:linear-gradient(135deg, #ff6100, #ff8c42);
      --brand-gradient-hover:linear-gradient(135deg, #e55a00, #ff7900);
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:linear-gradient(135deg, #f8f9fc 0%, #f1f3f8 100%);
    }

    html,body{background:var(--bg);}
    body{font-size:var(--font); color:var(--ink);}

    .wrap{
      max-width:min(760px, 94vw);
      margin:16px auto;
      padding:18px;
      border-radius:calc(var(--radius) + 4px);
    }

    h1{font-size:clamp(20px,3.8vw,28px); font-weight:800; margin-bottom:8px;}
    h3{font-size:clamp(18px,3.2vw,22px); font-weight:700; margin:6px 0 10px;}

    /* Secciones como tarjetas */
    .section{
      border:none;
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      margin-top:24px;
      box-shadow:0 8px 25px rgba(0,0,0,.08), 0 3px 6px rgba(0,0,0,.04);
      position:relative;
    }
    
    /* Header con gradiente */
    .section:first-of-type{
      background:var(--brand-gradient);
      color:#fff;
      box-shadow:0 10px 30px rgba(255, 97, 0, .20);
      min-height:80px;
    }
    .section:first-of-type .note{
      color:rgba(255,255,255,.8);
    }
    
    /* Logos del header */
    .section:first-of-type img{
      background:rgba(255,255,255,.95);
      padding:4px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
      transition:transform .2s ease;
    }
    .section:first-of-type img:hover{
      transform:scale(1.05);
    }
    
    /* Responsive logos */
    @media (max-width: 480px){
      .section:first-of-type{
        flex-direction:column;
        text-align:center;
        gap:8px;
      }
      .section:first-of-type img{
        width:40px;
        height:40px;
      }
    }

    /* Grid - SIEMPRE una sola columna para mejor UX m√≥vil */
    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
    }
    /* Mantener una columna incluso en desktop para formularios */
    .full{grid-column:1/-1}

    /* Secciones numeradas */
    .section h3::before{
      content:counter(section-counter) ". ";
      counter-increment:section-counter;
      color:var(--brand);
      font-weight:900;
    }
    .wrap{
      counter-reset:section-counter;
    }
    .section:first-of-type h3::before{
      display:none; /* No numerar el header */
    }
    
    /* Etiquetas y campos grandes (evita zoom iOS) */
    label{
      display:block; 
      font-weight:700; 
      font-size:var(--font-sm); 
      margin:8px 0 8px;
      line-height:1.3;
    }
    
    /* Label especial para cliente - texto m√°s grande */
    label[for="clienteSelect"]{
      font-size:calc(var(--font-sm) * 2);
      font-weight:800;
    }
    
    /* Labels con iconos */
    label[for="clienteSelect"]::before{content:"üè¢ ";}
    label[for="nombre_completo"]::before{content:"üë§ ";}
    label[for="documento_identidad"]::before{content:"üÜî ";}
    label[for="email"]::before{content:"üìß ";}
    label[for="telefono"]::before{content:"üì± ";}
    label[for="direccion_residencia"]::before{content:"üè† ";}
    label[for="f_nacimiento"]::before{content:"üìÖ ";}
    label[for="eps"]::before{content:"üè• ";}
    label[for="peso"]::before{content:"‚öñÔ∏è ";}
    label[for="estatura"]::before{content:"üìè ";}
    
    /* Campos requeridos */
    label[for="clienteSelect"]::after,
    label[for="nombre_completo"]::after,
    label[for="documento_identidad"]::after,
    label[for="f_nacimiento"]::after,
    label[for="email"]::after,
    label[for="telefono"]::after,
    label[for="direccion_residencia"]::after,
    label[for="eps"]::after,
    label[for="rh"]::after,
    label[for="peso"]::after,
    label[for="estatura"]::after,
    label[for="edad"]::after,
    label[for="enfermedades_importantes"]::after,
    label[for="medicamentos"]::after,
    label[for="restricciones_medicas"]::after,
    label[for="deporte_semana"]::after{
      content:" *";
      color:#e53e3e;
      font-weight:900;
    }
    
    /* Asteriscos ya incluidos en el texto del label */
    label:has(+ select[required])::after,
    label:has(+ input[required])::after,
    label:has(+ textarea[required])::after{
      content:"";
    }

    input,select,textarea{
      width:100%;
      min-height:calc(var(--fieldH) * 3); /* TRIPLICADO */
      padding:48px 54px; /* TRIPLICADO: de 16x18 a 48x54 */
      border:2px solid #d9dce3;
      border-radius:12px;
      background:#fff;
      font-size:54px; /* TRIPLICADO: de 18px a 54px */
      outline:none;
      transition:border .15s, box-shadow .15s, background .15s;
      box-sizing:border-box;
    }
    
    /* Placeholders m√°s grandes - DOBLE TAMA√ëO */
    input::placeholder,
    textarea::placeholder{
      font-size:108px!important; /* DOBLE del tama√±o actual: 54px x 2 = 108px */
      color:#9ca3af;
      opacity:0.7;
    }
    
    /* Placeholders espec√≠ficos m√°s peque√±os - MITAD DEL TAMA√ëO ACTUAL */
    #enfermedades_importantes::placeholder,
    #medicamentos::placeholder,
    #restricciones_medicas::placeholder,
    #deporte_semana::placeholder,
    #f_nacimiento::placeholder,
    #documento_identidad::placeholder,
    #telefono::placeholder,
    #email::placeholder,
    .estudio-nombre::placeholder,
    .estudio-institucion::placeholder,
    .estudio-anio::placeholder{
      font-size:54px!important; /* MITAD: de 108px a 54px */
      color:#9ca3af;
      opacity:0.7;
    }
    textarea{min-height:330px;} /* TRIPLICADO: de 110px a 330px */
    input:focus,select:focus,textarea:focus{
      border-color: var(--brand);
      box-shadow:0 0 0 4px rgba(26,115,232,.12);
    }

    /* Select2 escalado */
    .select2-container{width:100%!important; font-size:36px;}
    .select2-selection{
      min-height:calc(var(--fieldH) * 2)!important;
      border:2px solid #d9dce3!important;
      border-radius:12px!important;
    }
    .select2-selection__rendered{padding:32px 36px!important; line-height:52px!important;}
    .select2-selection__arrow{height:calc(var(--fieldH) * 2)!important;}
    .select2-results__option{padding:32px 36px!important; font-size:36px!important;}
    
    /* FIJAR Z-INDEX para que Select2 aparezca siempre encima */
    .select2-dropdown{
      z-index:99999!important; /* Aumentado a√∫n m√°s */
      border:2px solid #d9dce3!important;
      border-radius:12px!important;
      box-shadow:0 8px 25px rgba(0,0,0,.15)!important;
      max-height:400px!important; /* Asegurar altura m√°xima */
      overflow-y:auto!important; /* Scroll si hay muchas opciones */
    }
    .select2-container--open{
      z-index:99999!important; /* Aumentado a√∫n m√°s */
    }
    .select2-container--open .select2-dropdown--above{
      z-index:99999!important;
    }
    .select2-container--open .select2-dropdown--below{
      z-index:99999!important;
    }

    /* Botones grandes + primario vistoso */
    .row{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    button{
      min-height:var(--fieldH);
      padding:10px 16px;
      border:0; border-radius:12px;
      background:var(--brand-gradient);
      color:#fff;
      font-weight:800; letter-spacing:.2px;
      cursor:pointer;
      transition:all .2s ease;
      box-shadow:0 4px 12px rgba(255, 97, 0, .25);
    }
    button:hover{
      background:var(--brand-gradient-hover);
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(255, 97, 0, .35);
    }
    button.secondary{
      background:linear-gradient(135deg, #64748b, #7c8a99);
      box-shadow:0 4px 12px rgba(100, 116, 139, .25);
    }
    button:active{transform:scale(.98) translateY(0)}

    /* Bot√≥n Enviar normal (no sticky) */
    .actions{
      background:#fff; border:1px solid #e5e7eb;
      border-radius:16px; padding:10px;
      box-shadow:0 10px 24px rgba(0,0,0,.10);
      display:flex; gap:10px; flex-direction:column;
      margin-top:12px;
    }

    /* NUEVA secci√≥n de estudios - dise√±o vertical armonizado */
    #estudios-container{
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    
    .estudio-record{
      background: var(--card);
      border: 2px solid #e5e7eb;
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      position: relative;
    }
    
    .estudio-record label{
      font-size: calc(var(--font-sm) * 1.5); /* M√°s grande que labels normales */
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 12px;
      display: block;
    }
    
    .estudio-record input{
      width: 100%;
      min-height: calc(var(--fieldH) * 3); /* Mismo tama√±o que otros inputs */
      padding: 48px 54px; /* Mismo padding que otros inputs */
      border: 2px solid #d9dce3;
      border-radius: 12px;
      background: #fff;
      font-size: 54px; /* Mismo tama√±o de fuente que otros inputs */
      outline: none;
      transition: border .15s, box-shadow .15s;
      box-sizing: border-box;
    }
    
    .estudio-record input:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(26,115,232,.12);
    }
    
    .estudio-record input::placeholder{
      font-size: 54px!important; /* MITAD: de 108px a 54px */
      color: #9ca3af;
      opacity: 0.7;
    }
    
    .btn-remove-estudio{
      position: absolute;
      top: 16px;
      right: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #ea4335;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(234, 67, 53, 0.3);
      transition: all 0.2s ease;
    }
    
    .btn-remove-estudio:hover{
      background: #d33b2c;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(234, 67, 53, 0.4);
    }
    
    #btn-add-estudio{
      width: 100%;
      min-height: calc(var(--fieldH) * 1.5);
      padding: 24px 32px;
      border: 3px dashed #34a853;
      background: transparent;
      color: #34a853;
      border-radius: 16px;
      cursor: pointer;
      font-size: 28px; /* M√°s grande para destacar */
      font-weight: 700;
      touch-action: manipulation;
      margin-top: 24px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    #btn-add-estudio:hover{
      background: #f0f9f4;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 168, 83, 0.2);
    }

    /* Media: c√°mara y firma m√°s amigables */
    video,canvas#photoCanvas{
      width:100%; max-height:320px; border-radius:12px; background:#000;
      aspect-ratio:4/3; object-fit:cover;
    }
    .sig{height:220px; border-radius:12px;}
    
    /* Botones de foto m√°s grandes y touch-friendly - DUPLICADOS */
    #btnClearPhoto, #btnClearSig{
      min-height: 108px; /* DOBLE: de 54px a 108px */
      padding: 32px 48px; /* DOBLE: de 16x24 a 32x48 */
      font-size: 32px; /* DOBLE: de 16px a 32px */
      font-weight: 600;
      border-radius: 24px; /* DOBLE: de 12px a 24px */
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    /* Botones principales de c√°mara - DOBLE TAMA√ëO */
    #btnStartCam, #btnShot{
      min-height: 108px;
      padding: 32px 48px;
      font-size: 32px;
      font-weight: 700;
      border-radius: 16px;
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    #btnStartCam{
      background: #9c27b0;
      color: white;
      border: none;
    }
    #btnStartCam:hover{
      background: #7b1fa2;
      transform: translateY(-2px);
    }
    #btnShot{
      background: #1a73e8;
      color: white;
      border: none;
    }
    #btnShot:hover{
      background: #1557b0;
      transform: translateY(-2px);
    }
    #btnClearPhoto, #btnClearSig{
      background: #f1f3f4;
      color: #5f6368;
      border: 2px solid #dadce0;
    }
    #btnClearPhoto:hover, #btnClearSig:hover{
      background: #e8eaed;
      transform: translateY(-2px);
    }
    
    /* Bot√≥n de env√≠o m√°s grande pero fijo al final */
    #btnSubmit{
      min-height: 120px;
      padding: 36px 64px;
      font-size: 36px;
      font-weight: 700;
      border-radius: 28px;
      background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
      color: white;
      border: none;
      box-shadow: 0 8px 24px rgba(255, 123, 0, 0.3);
      touch-action: manipulation;
      transition: all 0.3s ease;
      width: 100%;
    }
    #btnSubmit:hover{
      background: linear-gradient(135deg, #e56b00 0%, #e58500 100%);
      transform: translateY(-6px);
      box-shadow: 0 12px 40px rgba(255, 123, 0, 0.4);
    }
    #btnSubmit:active{
      transform: translateY(-2px);
    }

    /* Estado/nota */
    .note{color:var(--muted); font-size:var(--font-sm);}
    #status{
      font-size:32px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:700;
      text-align:center;
      padding:24px;
      border-radius:16px;
      margin-top:24px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="section full" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <img src="https://lh3.googleusercontent.com/d/1VdWAxjvIhrvRulvjRRcRh38t4BEzxNJh" alt="Logo Empresa" style="width:48px;height:48px;border-radius:8px;object-fit:contain;" onerror="this.src='https://drive.google.com/thumbnail?id=1VdWAxjvIhrvRulvjRRcRh38t4BEzxNJh&sz=w200'">
      <div style="text-align:center;flex:1;">
        <div style="font-weight:800;line-height:1;font-size:calc(var(--font) * 4);">Formulario de Brigadistas</div>
        <div class="note" style="font-size:calc(var(--font-sm) * 4);">Completa los campos y adjunta foto y firma</div>
      </div>
      <img src="https://lh3.googleusercontent.com/d/1EX4yhuMo0r7dlklF4n5TbaCKRZ2skTx7" alt="Logo Secundario" style="width:48px;height:48px;border-radius:8px;object-fit:contain;" onerror="this.src='https://drive.google.com/thumbnail?id=1EX4yhuMo0r7dlklF4n5TbaCKRZ2skTx7&sz=w200'">
    </div>
    
    <h1 style="margin-top:48px;">Hoja de Vida ‚Äì Brigadista</h1>

    <!-- CLIENTE -->
    <div class="section">
      <h3>Selecci√≥n de Cliente</h3>
      <div class="grid">
        <div class="full">
          <label for="clienteSelect">üè¢ Cliente *</label>
          <select id="clienteSelect" required></select>
          <input type="hidden" id="idCliente" />
        </div>
      </div>
    </div>

    <!-- DATOS PERSONALES -->
    <div class="section">
      <h3>Datos Personales</h3>
      <div class="grid">
      <div>
        <label for="nombre_completo">Nombre completo *</label>
        <input id="nombre_completo" required />
      </div>
      <div>
        <label for="documento_identidad">Documento de identidad *</label>
        <input id="documento_identidad" type="text" pattern="[0-9]+" inputmode="numeric" maxlength="12" required placeholder="Ej: 1234567890" />
      </div>
      <div>
        <label for="f_nacimiento">Fecha de nacimiento *</label>
        <div style="position: relative;">
          <input id="f_nacimiento" type="text" pattern="\d{2}/\d{2}/\d{4}" placeholder="dd/mm/yyyy" maxlength="10" required style="padding-right: 50px;" />
          <input id="f_nacimiento_date" type="date" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; pointer-events: none;" />
          <button type="button" id="date-mode-toggle" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--brand-gradient); color: white; border: 0; border-radius: 6px; padding: 8px 10px; font-size: 16px; cursor: pointer; z-index: 10;">üìÖ</button>
        </div>
        <input type="hidden" id="f_nacimiento_iso" />
        <div id="date-mode-hint" style="font-size: 14px; color: #6b7280; margin-top: 4px;">‚úçÔ∏è Modo texto: Escribe dd/mm/yyyy</div>
      </div>
      <div>
        <label for="email">Email *</label>
        <input id="email" type="email" required placeholder="Ej: nombre@empresa.com" />
      </div>
      <div>
        <label for="telefono">Tel√©fono *</label>
        <input id="telefono" type="text" pattern="[0-9]{10}" inputmode="tel" maxlength="10" required placeholder="Ej: 3001234567" />
      </div>
      <div>
        <label for="direccion_residencia">Direcci√≥n *</label>
        <input id="direccion_residencia" required />
      </div>
      <div>
        <label for="eps">EPS *</label>
        <input id="eps" required />
      </div>
      <div>
        <label for="rh">ü©∏ RH *</label>
        <select id="rh" required>
          <option value="">-- Seleccionar tipo de sangre --</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
        </select>
      </div>
      <div>
        <label for="peso">Peso (kg) *</label>
        <input id="peso" type="number" step="0.1" required />
      </div>
      <div>
        <label for="estatura">Estatura (cm) *</label>
        <input id="estatura" type="number" step="0.1" required />
      </div>
      <div>
        <label for="edad">Edad *</label>
        <input id="edad" type="number" required />
      </div>
    </div>

    <!-- ESTUDIOS -->
    <div class="section">
      <div class="full"><h3>Estudios Relacionados con la Respuesta ante Emergencias</h3></div>
      <div id="estudios-container">
        <div class="estudio-record">
          <button type="button" class="btn-remove-estudio">√ó</button>
          
          <div>
            <label>üìö ¬øQu√© estudi√≥?</label>
            <input class="estudio-nombre" placeholder="Ej: Primeros Auxilios, Rescate en Alturas, Bombero..." />
          </div>
          
          <div>
            <label>üè¢ ¬øD√≥nde lo estudi√≥?</label>
            <input class="estudio-institucion" placeholder="Ej: Cruz Roja, Defensa Civil, SENA, Universidad..." />
          </div>
          
          <div>
            <label>üìÖ ¬øEn qu√© a√±o?</label>
            <input class="estudio-anio" type="number" placeholder="Ej: 2020" min="1950" max="2030" />
          </div>
        </div>
        <button type="button" id="btn-add-estudio">‚ûï Agregar otro estudio</button>
      </div>
    </div>

    <!-- SALUD -->
    <div class="section">
      <h3>Informaci√≥n de Salud</h3>
      <div class="grid">
      <div class="full">
        <label for="enfermedades_importantes">üè• Enfermedades importantes *</label>
        <textarea id="enfermedades_importantes" required placeholder="Indica si tienes alguna enfermedad importante o escribe 'Ninguna'"></textarea>
      </div>
      <div class="full">
        <label for="medicamentos">üíä Medicamentos *</label>
        <textarea id="medicamentos" required placeholder="Indica si tomas medicamentos o escribe 'Ninguno'"></textarea>
      </div>
      </div>
    </div>

    <!-- CUESTIONARIO M√âDICO -->
    <div class="section">
      <h3>Cuestionario M√©dico (S√≠/No)</h3>
      <div class="grid" style="margin-top: 12px;">
        <div>
          <label>1. ¬øAlguna vez su doctor le ha dicho que tenga alguna enfermedad cardiaca y le ha recomendado que s√≥lo practique ejercicio m√©dicamente prescrito?</label>
          <select id="cardiaca" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>2. ¬øSiente dolor en el pecho cuando hace alguna actividad f√≠sica?</label>
          <select id="pechoactividad" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>3. ¬øEn el mes pasado ha tenido dolor en el pecho en reposo?</label>
          <select id="dolorpecho" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>4. ¬øPierde usted el equilibrio por mareo o ha perdido la conciencia alguna vez?</label>
          <select id="conciencia" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>5. ¬øTiene usted alg√∫n problema de los huesos o articulaciones que pudieran empeorar por un cambio en la actividad f√≠sica?</label>
          <select id="huesos" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>6. ¬øEst√° su m√©dico prescribiendo actualmente medicamentos para la presi√≥n arterial, diabetes o alguna condici√≥n cardiaca?</label>
          <select id="medicamentos_bool" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>7. ¬øConoce alguna otra raz√≥n por la cual usted no pueda realizar actividad f√≠sica?</label>
          <select id="actividadfisica" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>8. ¬øHa sufrido o sufre de convulsiones o epilepsia?</label>
          <select id="convulsiones" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>9. ¬øSufre o ha sufrido de v√©rtigo?</label>
          <select id="vertigo" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>10. ¬øHa sufrido de enfermedades en los o√≠dos?</label>
          <select id="oidos" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>11. ¬øHa sufrido de miedo a los lugares cerrados (ascensores, cuartos peque√±os)?</label>
          <select id="lugarescerrados" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>12. ¬øHa sufrido de miedo a las alturas (aviones, puentes peatonales, terrazas)?</label>
          <select id="miedoalturas" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>13. ¬øHace en la semana ejercicio?</label>
          <select id="haceejercicio" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
        <div>
          <label>14. ¬øSufre de miedo al ver sangre?</label>
          <select id="miedo_ver_sangre" required>
            <option value="">-- Seleccionar --</option>
            <option value="SI">S√ç</option>
            <option value="NO">NO</option>
          </select>
        </div>
      </div>
      <div class="full">
        <label for="restricciones_medicas">Restricciones m√©dicas *</label>
        <textarea id="restricciones_medicas" required placeholder="Indica si tienes restricciones m√©dicas o escribe 'Ninguna'"></textarea>
      </div>
      <div class="full">
        <label for="deporte_semana">Deportes y horas/semana *</label>
        <textarea id="deporte_semana" required placeholder="Indica qu√© deportes practicas y cu√°ntas horas por semana, o escribe 'Ninguno'"></textarea>
      </div>
    </div>

    <!-- FOTO -->
    <div class="section">
      <label>üì∏ Foto del brigadista *</label>
      <div style="margin-bottom: 16px;">
        <button id="btnStartCam" type="button">üìπ Encender c√°mara</button>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="photoCanvas" style="display:none"></canvas>
      <div class="row">
        <button id="btnShot" type="button">üì∑ Tomar foto</button>
        <button id="btnClearPhoto" class="secondary" type="button">Borrar foto</button>
      </div>
      <!-- Fallback para dispositivos antiguos -->
      <div class="row" style="margin-top: 8px;">
        <label style="font-size: 1.8rem; color: #5f6368;">O seleccionar archivo:</label>
        <input type="file" id="fileInput" accept="image/*" capture="environment">
      </div>
    </div>

    <!-- FIRMA -->
    <div class="section">
      <label>‚úçÔ∏è Firma *</label>
      <canvas id="sigCanvas" class="sig"></canvas>
      <div class="row">
        <button id="btnClearSig" class="secondary" type="button">Borrar firma</button>
      </div>
    </div>

    <!-- ENV√çO -->
    <div class="section full">
      <div class="actions">
        <button id="btnSubmit" type="button">Enviar</button>
        <div id="status"></div>
      </div>
    </div>
  </div>

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <!-- Firma -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@5.0.4/dist/signature_pad.umd.min.js"></script>

  <script>
    // ===== Dropdown clientes activos =====
    function cargarClientes() {
      google.script.run.withSuccessHandler((list) => {
        const sel = $('#clienteSelect');
        sel.empty();
        sel.append('<option value="">-- Seleccione cliente --</option>');
        
        list.forEach(c => {
          sel.append(`<option value="${c.id}">${c.name}</option>`);
        });
        
        // Inicializar Select2 despu√©s de cargar los datos
        sel.select2({
          placeholder: '-- Seleccione o busque cliente --',
          allowClear: true,
          width: '100%',
          dropdownParent: $('body'), // CAMBIO: adjuntar al body para mejor z-index
          language: {
            noResults: () => 'No se encontraron resultados',
            searching: () => 'Buscando...'
          }
        });
        
        // Manejar el cambio de selecci√≥n
        sel.on('change', function() {
          document.getElementById('idCliente').value = this.value;
        });
        
      }).getActiveClients();
    }

    // El event listener ya no es necesario, se maneja en Select2

    // ===== C√°mara =====
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('photoCanvas');
    const btnStartCam = document.getElementById('btnStartCam');
    const btnShot = document.getElementById('btnShot');
    const btnClearPhoto = document.getElementById('btnClearPhoto');
    const fileInput = document.getElementById('fileInput');
    let stream = null, photoDataUrl = '';

    btnStartCam.onclick = async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (e) {
        alert('No se pudo acceder a la c√°mara: ' + e);
      }
    };

    btnShot.onclick = () => {
      const w = video.videoWidth || 640, h = video.videoHeight || 480;
      photoCanvas.width = w; photoCanvas.height = h;
      const ctx = photoCanvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      photoDataUrl = photoCanvas.toDataURL('image/png');
      photoCanvas.style.display = 'block';
    };

    btnClearPhoto.onclick = () => {
      const ctx = photoCanvas.getContext('2d');
      ctx.clearRect(0,0,photoCanvas.width,photoCanvas.height);
      photoCanvas.style.display = 'none';
      photoDataUrl = '';
      fileInput.value = '';
    };

    // Fallback: selecci√≥n de archivo
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            photoCanvas.width = img.width;
            photoCanvas.height = img.height;
            const ctx = photoCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            photoDataUrl = photoCanvas.toDataURL('image/png');
            photoCanvas.style.display = 'block';
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    };

    // ===== Firma =====
    const sigCanvas = document.getElementById('sigCanvas');
    let signaturePad = null;
    
    function initSignature() {
      // Configurar el tama√±o del canvas correctamente
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const canvasRect = sigCanvas.getBoundingClientRect();
        
        sigCanvas.width = canvasRect.width * ratio;
        sigCanvas.height = canvasRect.height * ratio;
        sigCanvas.getContext("2d").scale(ratio, ratio);
        
        // Reinicializar SignaturePad despu√©s del redimensionado
        if (signaturePad) {
          signaturePad.clear();
        }
        signaturePad = new SignaturePad(sigCanvas, {
          minWidth: 0.5,
          maxWidth: 2.5,
          penColor: 'rgb(66, 133, 244)'
        });
      }
      
      resizeCanvas();
      
      // Redimensionar cuando cambie el tama√±o de la ventana
      window.addEventListener('resize', resizeCanvas);
      window.addEventListener('orientationchange', () => {
        setTimeout(resizeCanvas, 100);
      });
    }
    
    document.getElementById('btnClearSig').onclick = () => signaturePad && signaturePad.clear();

    // ===== Funciones auxiliares =====
    function calcEdad_(yyyy_mm_dd) {
      if (!yyyy_mm_dd) return '';
      const b = new Date(yyyy_mm_dd), t = new Date();
      let e = t.getFullYear() - b.getFullYear();
      const m = t.getMonth() - b.getMonth();
      if (m < 0 || (m === 0 && t.getDate() < b.getDate())) e--;
      return e;
    }
    
    // Convertir SI/NO a booleanos
    const toBool = v => v === 'SI' ? true : v === 'NO' ? false : '';
    
    // Convertir a n√∫mero o dejar en blanco
    const numOrBlank = v => v !== '' ? Number(v) : '';
    
    // ===== Manejo de fecha de nacimiento formato dd/mm/yyyy =====
    function formatDateInput(input) {
      let value = input.replace(/\D/g, ''); // Solo n√∫meros
      if (value.length >= 2) {
        value = value.substring(0,2) + '/' + value.substring(2);
      }
      if (value.length >= 5) {
        value = value.substring(0,5) + '/' + value.substring(5,9);
      }
      return value;
    }
    
    function validateAndConvertDate(ddmmyyyy) {
      const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = ddmmyyyy.match(regex);
      
      if (!match) return null;
      
      const [, day, month, year] = match;
      const date = new Date(year, month - 1, day);
      
      // Verificar que la fecha es v√°lida
      if (date.getFullYear() != year || 
          date.getMonth() != (month - 1) || 
          date.getDate() != day) {
        return null;
      }
      
      // Verificar rango razonable (entre 1920 y hoy)
      const today = new Date();
      const minYear = 1920;
      if (date > today || parseInt(year) < minYear) {
        return null;
      }
      
      return {
        iso: year + '-' + month.padStart(2,'0') + '-' + day.padStart(2,'0'),
        date: date
      };
    }
    
    // Event listeners para fecha de nacimiento con toggle m√≥vil
    const textDateInput = document.getElementById('f_nacimiento');
    const calendarInput = document.getElementById('f_nacimiento_date');
    const isoHidden = document.getElementById('f_nacimiento_iso');
    const edadInput = document.getElementById('edad');
    const toggleButton = document.getElementById('date-mode-toggle');
    const modeHint = document.getElementById('date-mode-hint');
    
    let isCalendarMode = false;
    
    // Funci√≥n para convertir ISO a dd/mm/yyyy
    function isoToDisplayDate(isoDate) {
      if (!isoDate) return '';
      const [year, month, day] = isoDate.split('-');
      return `${day}/${month}/${year}`;
    }
    
    // Cambiar entre modo texto y calendario
    function toggleDateMode() {
      isCalendarMode = !isCalendarMode;
      
      if (isCalendarMode) {
        // Activar modo calendario
        calendarInput.style.pointerEvents = 'auto';
        calendarInput.style.opacity = '1';
        textDateInput.style.pointerEvents = 'none';
        textDateInput.style.opacity = '0.7';
        toggleButton.textContent = '‚úçÔ∏è';
        modeHint.textContent = 'üìÖ Modo calendario: Toca para seleccionar fecha';
      } else {
        // Activar modo texto
        calendarInput.style.pointerEvents = 'none';
        calendarInput.style.opacity = '0';
        textDateInput.style.pointerEvents = 'auto';
        textDateInput.style.opacity = '1';
        toggleButton.textContent = 'üìÖ';
        modeHint.textContent = '‚úçÔ∏è Modo texto: Escribe dd/mm/yyyy';
        textDateInput.focus();
      }
    }
    
    // Bot√≥n toggle
    toggleButton.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleDateMode();
    });
    
    // Formateo autom√°tico para input de texto
    textDateInput.addEventListener('input', (e) => {
      e.target.value = formatDateInput(e.target.value);
    });
    
    // Validaci√≥n cuando se sale del campo de texto
    textDateInput.addEventListener('blur', (e) => {
      const result = validateAndConvertDate(e.target.value);
      if (result) {
        isoHidden.value = result.iso;
        calendarInput.value = result.iso; // Sincronizar calendario
        const edad = calcEdad_(result.iso);
        edadInput.value = edad;
        e.target.style.borderColor = '#d9dce3'; // Reset border
      } else if (e.target.value) {
        e.target.style.borderColor = '#e53e3e'; // Error border
        isoHidden.value = '';
        calendarInput.value = '';
        edadInput.value = '';
      }
    });
    
    // Cuando se selecciona fecha del calendario
    calendarInput.addEventListener('change', (e) => {
      if (e.target.value) {
        const displayDate = isoToDisplayDate(e.target.value);
        textDateInput.value = displayDate;
        isoHidden.value = e.target.value;
        const edad = calcEdad_(e.target.value);
        edadInput.value = edad;
        textDateInput.style.borderColor = '#d9dce3';
        // Volver a modo texto despu√©s de seleccionar
        setTimeout(() => {
          isCalendarMode = true; // Para que toggleDateMode() cambie a texto
          toggleDateMode();
        }, 500);
      }
    });

    // ===== Env√≠o =====
    const statusEl = document.getElementById('status');
    const btnSubmit = document.getElementById('btnSubmit');
    
    function stopCamera_() {
      try {
        stream && stream.getTracks().forEach(t => t.stop());
      } catch(_) {}
    }
    
    btnSubmit.onclick = () => {
      const id_cliente = document.getElementById('idCliente').value;
      const clienteSel = document.getElementById('clienteSelect');
      const cliente = clienteSel.selectedOptions[0]?.textContent || '';

      const nombre_completo = document.getElementById('nombre_completo').value.trim();
      const documento_identidad = document.getElementById('documento_identidad').value.trim();
      const rh = document.getElementById('rh').value;
      const f_nacimiento = document.getElementById('f_nacimiento').value;
      const f_nacimiento_iso = document.getElementById('f_nacimiento_iso').value;
      
      // ===== VALIDACI√ìN COMPLETA DE TODOS LOS CAMPOS OBLIGATORIOS =====
      const missingFields = [];
      const fieldLabels = {
        'clienteSelect': 'Cliente',
        'nombre_completo': 'Nombre completo', 
        'documento_identidad': 'Documento de identidad',
        'f_nacimiento': 'Fecha de nacimiento',
        'email': 'Email',
        'telefono': 'Tel√©fono',
        'direccion_residencia': 'Direcci√≥n',
        'eps': 'EPS',
        'rh': 'Tipo de sangre (RH)',
        'peso': 'Peso (kg)',
        'estatura': 'Estatura (cm)',
        'edad': 'Edad',
        'enfermedades_importantes': 'Enfermedades importantes',
        'medicamentos': 'Medicamentos',
        'restricciones_medicas': 'Restricciones m√©dicas',
        'deporte_semana': 'Deportes y horas por semana'
      };
      
      // Validar campos b√°sicos
      Object.keys(fieldLabels).forEach(fieldId => {
        const field = document.getElementById(fieldId);
        let isEmpty = false;
        
        // Validaci√≥n especial para fecha de nacimiento
        if (fieldId === 'f_nacimiento') {
          isEmpty = !f_nacimiento_iso; // Usar el campo ISO convertido
        } else {
          isEmpty = !field || !field.value.trim();
        }
        
        if (isEmpty) {
          missingFields.push(fieldLabels[fieldId]);
          if (field) field.style.borderColor = '#e53e3e'; // Marcar en rojo
        } else if (field) {
          field.style.borderColor = '#d9dce3'; // Reset
        }
      });
      
      // Validar cuestionario m√©dico - TODAS las preguntas son obligatorias
      const medicalQuestions = [
        { id: 'cardiaca', label: '¬øProblemas card√≠acos?' },
        { id: 'pechoactividad', label: '¬øDolor en el pecho durante actividad?' },
        { id: 'dolorpecho', label: '¬øDolor en el pecho en reposo?' },
        { id: 'conciencia', label: '¬øP√©rdida de conciencia?' },
        { id: 'huesos', label: '¬øProblemas en huesos o articulaciones?' },
        { id: 'medicamentos_bool', label: '¬øMedicamentos para presi√≥n/diabetes/coraz√≥n?' },
        { id: 'actividadfisica', label: '¬øActividad f√≠sica contraindicada?' },
        { id: 'convulsiones', label: '¬øConvulsiones?' },
        { id: 'vertigo', label: '¬øV√©rtigo?' },
        { id: 'oidos', label: '¬øProblemas de o√≠dos?' },
        { id: 'lugarescerrados', label: '¬øMiedo a lugares cerrados?' },
        { id: 'miedoalturas', label: '¬øMiedo a las alturas?' },
        { id: 'haceejercicio', label: '¬øHace ejercicio regularmente?' },
        { id: 'miedo_ver_sangre', label: '¬øMiedo a ver sangre?' }
      ];
      
      medicalQuestions.forEach(q => {
        const field = document.getElementById(q.id);
        if (field && !field.value) {
          missingFields.push(q.label);
          field.style.borderColor = '#e53e3e';
        } else if (field) {
          field.style.borderColor = '#d9dce3';
        }
      });
      
      // Validar foto
      if (!photoDataUrl) {
        missingFields.push('Foto del brigadista');
      }
      
      // Validar firma
      if (!signaturePad || signaturePad.isEmpty()) {
        missingFields.push('Firma');
      }
      
      // Mostrar campos faltantes
      if (missingFields.length > 0) {
        const message = `Faltan los siguientes campos obligatorios:\n\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}\n\nPor favor completa todos los campos para continuar.`;
        alert(message);
        return;
      }
      
      // Validaciones espec√≠ficas despu√©s de verificar que existen
      
      // VALIDACI√ìN DOCUMENTO: Solo n√∫meros enteros, sin puntos ni comas
      if (!/^\d+$/.test(documento_identidad) || documento_identidad <= 0) {
        alert('El documento de identidad debe ser un n√∫mero entero v√°lido (sin puntos, comas o letras).\n\nEjemplos v√°lidos: 12345678, 1234567890\nEjemplos inv√°lidos: 12.345.678, 12,345,678, abc123');
        document.getElementById('documento_identidad').style.borderColor = '#e53e3e';
        return;
      }
      
      // VALIDACI√ìN TEL√âFONO: Exactamente 10 d√≠gitos
      const telefono = document.getElementById('telefono').value.trim();
      if (!/^\d{10}$/.test(telefono)) {
        alert('El tel√©fono debe tener exactamente 10 d√≠gitos.\n\nEjemplo v√°lido: 3001234567\nEjemplos inv√°lidos: 300-123-4567, 300 123 4567, 123456789');
        document.getElementById('telefono').style.borderColor = '#e53e3e';
        return;
      }
      
      // VALIDACI√ìN EMAIL: Formato de email v√°lido
      const email = document.getElementById('email').value.trim();
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(email)) {
        alert('El email debe tener un formato v√°lido.\n\nEjemplos v√°lidos: nombre@empresa.com, juan.perez@gmail.com\nEjemplos inv√°lidos: nombre@, @empresa.com, nombre.empresa');
        document.getElementById('email').style.borderColor = '#e53e3e';
        return;
      }
      
      if (rh && !/^(O|A|B|AB)[+-]$/.test(rh)) {
        alert('Tipo de sangre inv√°lido.');
        document.getElementById('rh').style.borderColor = '#e53e3e';
        return;
      }
      
      if (f_nacimiento && !f_nacimiento_iso) {
        alert('Formato de fecha inv√°lido. Use el formato dd/mm/yyyy (ejemplo: 15/03/1990).');
        document.getElementById('f_nacimiento').style.borderColor = '#e53e3e';
        return;
      }

      const payload = {
        // m√≠nimos obligatorios
        id_cliente,
        cliente,
        nombre_completo,
        documento_identidad,

        // resto de campos
        f_nacimiento: f_nacimiento_iso || '',
        email: document.getElementById('email').value,
        telefono: document.getElementById('telefono').value,
        direccion_residencia: document.getElementById('direccion_residencia').value,
        edad: numOrBlank(document.getElementById('edad').value) || calcEdad_(f_nacimiento_iso),
        eps: document.getElementById('eps').value,
        rh: document.getElementById('rh').value,
        peso: numOrBlank(document.getElementById('peso').value),
        estatura: numOrBlank(document.getElementById('estatura').value),
        
        // estudios (array din√°mico)
        estudios: collectEstudiosData(),
        
        // salud
        enfermedades_importantes: document.getElementById('enfermedades_importantes').value,
        medicamentos: document.getElementById('medicamentos').value,
        
        // cuestionario m√©dico (convertido a booleanos)
        cardiaca: toBool(document.getElementById('cardiaca').value),
        pechoactividad: toBool(document.getElementById('pechoactividad').value),
        dolorpecho: toBool(document.getElementById('dolorpecho').value),
        conciencia: toBool(document.getElementById('conciencia').value),
        huesos: toBool(document.getElementById('huesos').value),
        medicamentos_bool: toBool(document.getElementById('medicamentos_bool').value),
        actividadfisica: toBool(document.getElementById('actividadfisica').value),
        convulsiones: toBool(document.getElementById('convulsiones').value),
        vertigo: toBool(document.getElementById('vertigo').value),
        oidos: toBool(document.getElementById('oidos').value),
        lugarescerrados: toBool(document.getElementById('lugarescerrados').value),
        miedoalturas: toBool(document.getElementById('miedoalturas').value),
        haceejercicio: toBool(document.getElementById('haceejercicio').value),
        miedo_ver_sangre: toBool(document.getElementById('miedo_ver_sangre').value),
        restricciones_medicas: document.getElementById('restricciones_medicas').value,
        deporte_semana: document.getElementById('deporte_semana').value,

        // multimedia
        photoDataUrl: photoDataUrl || '',
        signatureDataUrl: (signaturePad && !signaturePad.isEmpty()) ? signaturePad.toDataURL('image/png') : '',

        // utilidades
        fecha_inscripcion: new Date().toISOString().slice(0,10) // YYYY-MM-DD
      };

      // Prevenir doble env√≠o
      btnSubmit.disabled = true;
      statusEl.textContent = 'Enviando‚Ä¶';
      
      google.script.run
        .withSuccessHandler((res) => {
          statusEl.textContent = res?.ok ? '¬°Enviado! ‚úÖ' : 'Error al guardar';
          btnSubmit.disabled = false;
          stopCamera_();
          // (Opcional) limpiar formulario:
          // document.querySelector('form')?.reset();
          // signaturePad.clear(); photoDataUrl=''; photoCanvas.style.display='none';
        })
        .withFailureHandler(err => {
          statusEl.textContent = 'Error: ' + err;
          btnSubmit.disabled = false;
          stopCamera_();
        })
        .saveSubmission(payload);
    };

    // ===== Gesti√≥n de estudios din√°micos - NUEVO DISE√ëO =====
    function addEstudioRecord() {
      const container = document.getElementById('estudios-container');
      const addButton = document.getElementById('btn-add-estudio');
      
      const recordDiv = document.createElement('div');
      recordDiv.className = 'estudio-record';
      
      recordDiv.innerHTML = `
        <button type="button" class="btn-remove-estudio">√ó</button>
        
        <div>
          <label>üìö ¬øQu√© estudi√≥?</label>
          <input class="estudio-nombre" placeholder="Ej: Primeros Auxilios, Rescate en Alturas, Bombero..." />
        </div>
        
        <div>
          <label>üè¢ ¬øD√≥nde lo estudi√≥?</label>
          <input class="estudio-institucion" placeholder="Ej: Cruz Roja, Defensa Civil, SENA, Universidad..." />
        </div>
        
        <div>
          <label>üìÖ ¬øEn qu√© a√±o?</label>
          <input class="estudio-anio" type="number" placeholder="Ej: 2020" min="1950" max="2030" />
        </div>
      `;
      
      container.insertBefore(recordDiv, addButton);
      
      const removeBtn = recordDiv.querySelector('.btn-remove-estudio');
      removeBtn.addEventListener('click', () => {
        recordDiv.remove();
      });
    }
    
    function collectEstudiosData() {
      const records = document.querySelectorAll('.estudio-record');
      const estudios = [];
      
      records.forEach(record => {
        const nombre = record.querySelector('.estudio-nombre').value.trim();
        const institucion = record.querySelector('.estudio-institucion').value.trim();
        const anio = record.querySelector('.estudio-anio').value;
        
        if (nombre || institucion || anio) {
          estudios.push({
            nombre: nombre,
            institucion: institucion,
            anio: anio ? Number(anio) : ''
          });
        }
      });
      
      return estudios;
    }

    // init
    window.addEventListener('load', () => {
      cargarClientes();
      initSignature();
      
      document.getElementById('btn-add-estudio').addEventListener('click', addEstudioRecord);
      
      document.querySelectorAll('.btn-remove-estudio').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.estudio-record').remove();
        });
      });
    });
  </script>
</body>
</html>

